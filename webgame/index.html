<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ë™ë„¤ - ì™„ì „íŒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        
        /* ë¡œê·¸ì¸/ë‚˜ì´ ì„ íƒ */
        .login-screen, .age-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px;
        }
        .age-screen { display: none; }
        
        .card { 
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 500px; 
            width: 100%; margin-bottom: 20px; 
        }
        
        h1 { font-size: 32px; margin-bottom: 10px; text-align: center; color: #333; }
        h3 { font-size: 20px; margin-bottom: 15px; color: #333; }
        p { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }
        
        input { 
            width: 100%; padding: 15px; border: 2px solid #ddd; 
            border-radius: 10px; font-size: 16px; margin-bottom: 15px; 
        }
        input:focus { outline: none; border-color: #667eea; }
        
        .btn { 
            width: 100%; padding: 15px; 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; border: none; border-radius: 10px; 
            font-size: 16px; font-weight: 600; cursor: pointer; 
            transition: transform 0.2s; 
        }
        .btn:hover { transform: translateY(-2px); }
        
        .age-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .age-btn { 
            padding: 20px; background: #f8f9fa; border: 2px solid #ddd; 
            border-radius: 12px; cursor: pointer; text-align: center; 
            transition: all 0.3s; 
        }
        .age-btn:hover { background: #e9ecef; }
        .age-btn.selected { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; border-color: #667eea; 
        }
        
        /* ê²Œì„ í™”ë©´ */
        .game-screen { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: white; padding: 20px; border-radius: 15px; 
            margin-bottom: 20px; display: flex; 
            justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .username { font-size: 20px; font-weight: 600; color: #333; }
        .gold { font-size: 24px; font-weight: 700; color: #FFD700; }
        
        /* íƒ­ */
        .tabs { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; }
        .tab { 
            padding: 10px 14px; background: white; border: none; 
            border-radius: 10px; cursor: pointer; font-size: 13px; 
            white-space: nowrap; transition: all 0.3s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .tab.active { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
        }
        
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* ìƒí’ˆ ê·¸ë¦¬ë“œ */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
        }
        
        .product-card { 
            background: #f8f9fa; padding: 15px; border-radius: 12px; 
            text-align: center; cursor: pointer; border: 3px solid transparent; 
            transition: all 0.3s; position: relative; 
        }
        .product-card:hover { background: #e9ecef; transform: translateY(-2px); }
        .product-card.selected { 
            border-color: #667eea; 
            background: linear-gradient(135deg, #F0F4FF, #E8F5FF); 
            box-shadow: 0 4px 12px rgba(102,126,234,0.3); 
        }
        .product-card.selected::before { 
            content: 'âœ“'; position: absolute; top: 5px; right: 5px; 
            width: 24px; height: 24px; background: #667eea; 
            color: white; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 14px; 
        }
        
        .product-emoji { font-size: 48px; margin-bottom: 8px; }
        .product-name { font-size: 14px; font-weight: 600; color: #333; }
        
        /* ìƒì  ì•„ì´í…œ */
        .shop-item { 
            background: #f8f9fa; padding: 15px; border-radius: 12px; 
            margin-bottom: 10px; display: flex; align-items: center; 
            justify-content: space-between; 
        }
        .shop-emoji { font-size: 36px; }
        .shop-details { flex: 1; margin-left: 15px; }
        .shop-name { font-weight: 600; color: #333; margin-bottom: 3px; }
        .shop-price { font-size: 13px; color: #667eea; }
        .shop-btn { 
            padding: 10px 20px; background: #667eea; color: white; 
            border: none; border-radius: 8px; cursor: pointer; 
            font-size: 13px; margin-left: 5px; 
        }
        .shop-btn:hover { background: #5568d3; }
        
        /* Toast */
        .toast { 
            position: fixed; top: 20px; right: 20px; 
            background: #333; color: white; padding: 15px 30px; 
            border-radius: 30px; z-index: 10000; display: none; 
        }
        .toast.show { display: block; }
        
        /* ëª¨ë‹¬ */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; align-items: center; 
            z-index: 9999; 
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; padding: 30px; border-radius: 20px; 
            max-width: 500px; width: 90%; max-height: 80vh; 
            overflow-y: auto; 
        }
        .modal-title { 
            font-size: 24px; font-weight: 700; 
            margin-bottom: 20px; text-align: center; color: #333; 
        }
        
        /* ë§¤ì¥ ì—†ì„ ë•Œ */
        .no-shop { text-align: center; padding: 60px 20px; }
        .no-shop-icon { font-size: 80px; margin-bottom: 20px; }
        .no-shop-text { font-size: 24px; font-weight: 600; color: #333; margin-bottom: 10px; }
        .no-shop-desc { font-size: 14px; color: #666; margin-bottom: 30px; }
        
        /* ì—…ì¢… ì„ íƒ */
        .business-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); 
            gap: 15px; margin-bottom: 20px; 
        }
        .business-btn { 
            padding: 20px; background: #f8f9fa; border: 2px solid #ddd; 
            border-radius: 12px; cursor: pointer; text-align: center; 
            transition: all 0.3s; 
        }
        .business-btn:hover { background: #e9ecef; }
        .business-btn.selected { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
        }
        
        /* ì‘ì—… ì˜ì—­ */
        .work-area { 
            background: white; padding: 25px; border-radius: 15px; 
            margin-top: 20px; text-align: center; 
        }
        .ingredient-item { 
            background: #f8f9fa; padding: 12px; border-radius: 10px; 
            margin-bottom: 10px; display: flex; 
            justify-content: space-between; align-items: center; 
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="card">
            <h1>ğŸ˜ï¸ ìš°ë¦¬ë™ë„¤</h1>
            <p>ë§ˆì„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
            <input type="text" id="usernameInput" placeholder="ì•„ì´ë”” ì…ë ¥ (2ê¸€ì ì´ìƒ)" maxlength="10">
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬ ì´ìƒ)" maxlength="20" style="margin-top:10px;">
            <button class="btn" onclick="login()">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>
            <p style="font-size:11px;color:#999;margin-top:10px;">ì²˜ìŒì´ë©´ ìë™ ê°€ì…ë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- ë‚˜ì´ ì„ íƒ í™”ë©´ -->
    <div id="ageScreen" class="age-screen">
        <div class="card">
            <h1>ë‚˜ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”</h1>
            <p>ë¬¸ì œ ë‚œì´ë„ê°€ ë‚˜ì´ì— ë§ì¶°ì§‘ë‹ˆë‹¤</p>
            <div class="age-grid">
                <div class="age-btn" onclick="selectAge(5)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ§¸</div>
                    <div>5ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(6)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ§¸</div>
                    <div>6ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(7)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ‘¶</div>
                    <div>7ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(8)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ§’</div>
                    <div>8ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(9)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ§’</div>
                    <div>9ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(10)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ§’</div>
                    <div>10ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(11)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ‘¦</div>
                    <div>11ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(12)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ‘¦</div>
                    <div>12ì„¸</div>
                </div>
                <div class="age-btn" onclick="selectAge(13)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ‘¦</div>
                    <div>13ì„¸</div>
                </div>
            </div>
                    <div>7ì„¸ (ì´ˆë“±)</div>
                </div>
                <div class="age-btn" onclick="selectAge(12)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ§’</div>
                    <div>12ì„¸ (ì¤‘ë“±)</div>
                </div>
                <div class="age-btn" onclick="selectAge(15)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ‘¦</div>
                    <div>15ì„¸ (ê³ ë“±)</div>
                </div>
                <div class="age-btn" onclick="selectAge(20)">
                    <div style="font-size:32px;margin-bottom:5px;">ğŸ‘¨</div>
                    <div>20ì„¸ (ì„±ì¸)</div>
                </div>
            </div>
            <div style="font-size:12px;color:#666;margin-top:10px;">ë‚˜ì´ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.</div>
</div>
    </div>

    <!-- ì—…ì¢… ì„ íƒ ëª¨ë‹¬ -->
    <div id="businessModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ’¼ ì—…ì¢… ì„ íƒ</div>
            <p style="font-size:13px;color:#666;margin-bottom:15px;">ì–´ë–¤ ë§¤ì¥ì„ ìš´ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="business-grid" id="businessGrid"></div>
            <button class="btn" style="background:#999;" onclick="closeBusinessModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ê°€ê²© ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="priceModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ’° ê°€ê²© ìˆ˜ì •</div>
            <div id="priceProduct"></div>
            <input type="number" id="newPrice" placeholder="ìƒˆ ê°€ê²© ì…ë ¥" min="1">
            <button class="btn" onclick="updatePrice()">ìˆ˜ì •</button>
            <button class="btn" style="background:#999;margin-top:10px;" onclick="closePriceModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- AI ëŒ“ê¸€ ëª¨ë‹¬ -->
    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ’¬ AI ëŒ“ê¸€</div>
            <div id="commentsContainer" style="max-height:400px;overflow-y:auto;"></div>
            <button class="btn" style="background:#999;margin-top:10px;" onclick="closeCommentsModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ìƒì  ì „í™˜ ëª¨ë‹¬ -->
    <div id="shopSwitchModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸª ìƒì  ì „í™˜</div>
            <p style="font-size:13px;color:#666;margin-bottom:15px;">ì œì‘í•  ìƒì ì„ ì„ íƒí•˜ì„¸ìš”</p>
            <div id="shopSwitchList"></div>
            <button class="btn" style="background:#999;margin-top:10px;" onclick="closeShopSwitchModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ìƒì  ë°©ë¬¸ ëª¨ë‹¬ -->
    <div id="visitModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="visitTitle">ğŸª ê°€ê²Œ ë°©ë¬¸</div>
            <div id="visitContent" style="max-height:400px;overflow-y:auto;"></div>
            <button class="btn" style="background:#999;margin-top:10px;" onclick="closeVisitModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen" class="game-screen">
        <div class="header">
            <span class="username" id="displayUsername">í”Œë ˆì´ì–´</span>
            <span class="gold">ğŸ’° <span id="gold">500</span>G</span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ‘¨â€ğŸ³ ì œì‘</button>
            <button class="tab" onclick="switchTab(1)">ğŸª ë§ˆíŠ¸</button>
            <button class="tab" onclick="switchTab(2)">ğŸ¬ ë‚´ë§¤ì¥</button>
            <button class="tab" onclick="switchTab(3)">ğŸ˜ï¸ ë§ˆì„</button>
            <button class="tab" onclick="switchTab(4)">ğŸ’° ê³¨ë“œ</button>
            <button class="tab" onclick="switchTab(5)">ğŸ“Š í†µê³„</button>
        </div>

        <!-- ì œì‘ íŒ¨ë„ -->
        <div id="panel0" class="panel active">
            <div id="noShopCard" class="card" style="display:none;">
                <div class="no-shop">
                    <div class="no-shop-icon">ğŸª</div>
                    <div class="no-shop-text">ì•„ì§ ë§¤ì¥ì´ ì—†ì–´ìš”</div>
                    <div class="no-shop-desc">ë§¤ì¥ì„ ë§Œë“¤ì–´ì„œ ìƒí’ˆì„ íŒë§¤í•´ë³´ì„¸ìš”!<br>ë¹„ìš©: <span id="firstShopCost">300</span>ê³¨ë“œ</div>
                    <button class="btn" onclick="openBusinessModal()">ğŸ’° ë§¤ì¥ ì¶”ê°€í•˜ê¸°</button>
                </div>
            </div>
            
            <div id="hasShopArea" style="display:none;">
                <!-- í˜„ì¬ ìƒì  ì •ë³´ -->
                <div class="card" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <div style="font-size:15px;font-weight:700;">ğŸª í˜„ì¬ ì œì‘ ì¤‘ì¸ ìƒì </div>
                        <button class="btn" style="background:white;color:#667eea;padding:8px 16px;width:auto;font-size:13px;" onclick="openShopSwitchModal()">ìƒì  ì „í™˜</button>
                    </div>
                    <div id="craftingShopInfo"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸ“‹ ìƒí’ˆ ì„ íƒ</h3>
                    <div class="product-grid" id="productGrid"></div>
                </div>
                
                <div id="workArea" style="display:none;" class="work-area">
                    <div style="font-size:80px;margin-bottom:10px;" id="previewEmoji">ğŸ°</div>
                    <div style="font-size:24px;font-weight:700;margin-bottom:20px;" id="previewName">ìƒí’ˆ</div>
                    <div id="ingredientList"></div>
                    <div style="display:flex;gap:10px;margin-top:12px;">
                        <button class="btn" style="background:#f3f4f6;color:#333;" onclick="goShoppingForCurrentProduct()">ğŸ›’ ì¥ë³´ëŸ¬ê°€ê¸°</button>
                        <button class="btn" id="makeBtn" onclick="completeProduct()">ğŸ‘¨â€ğŸ³ ë§Œë“¤ê¸°</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë§ˆíŠ¸ íŒ¨ë„ -->
        <div id="panel1" class="panel">
            <div class="card">
                <h3 style="margin-bottom:15px;">ğŸª ì¬ë£Œ êµ¬ë§¤</h3>
                <div id="quickCartWrap" style="margin-bottom:12px;display:block;">
                    <button class="btn" style="background:#f3f4f6;color:#333;" onclick="fillCartFromSelectedProduct()">ğŸ§º ì¥ë°”êµ¬ë‹ˆì— ë°”ë¡œ ë‹´ê¸°</button>
                </div>
                <div id="cartArea" style="margin-bottom:18px;display:none;"></div>
                <div id="shopList"></div>
            </div>
        </div>

        <!-- ë‚´ë§¤ì¥ íŒ¨ë„ -->
        <div id="panel2" class="panel">
            <div class="card">
                <h3 style="margin-bottom:15px;">ğŸ¬ ë‚´ ë§¤ì¥</h3>
                
                <!-- ìƒì  ê´€ë¦¬ -->
                <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:15px;margin-bottom:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <div style="font-size:15px;font-weight:700;">ğŸª ìš´ì˜ ì¤‘ì¸ ìƒì </div>
                        <button class="btn" style="background:white;color:#667eea;padding:8px 16px;width:auto;font-size:13px;" onclick="openAddShopModal()">+ ìƒì  ì¶”ê°€ (<span id="addShopCost">500</span>G)</button>
                    </div>
                    <div id="currentShopInfo"></div>
                    <div id="shopSwitcher"></div>
                </div>

                <!-- íŒë§¤ í†µê³„ -->
                <div id="salesStats"></div>
                
                <p style="font-size:12px;color:#999;margin-bottom:15px;">í´ë¦­í•´ì„œ ê°€ê²©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ëŒ“ê¸€ì„ í™•ì¸í•˜ì„¸ìš”</p>
                <div id="completedList"></div>
            </div>
        </div>

        <!-- ë§ˆì„ íŒ¨ë„ (ì¹œêµ¬ì™€ í•¨ê»˜ í•˜ê¸°) -->
        <div id="panel3" class="panel">
            <div class="card">
                <h3 style="margin-bottom:5px;">ğŸ˜ï¸ ìš°ë¦¬ ë§ˆì„</h3>
                <p style="font-size:13px;color:#666;margin-bottom:15px;">ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ìƒì ì„ ë°©ë¬¸í•˜ê³  ìƒí’ˆì„ êµ¬ë§¤í•˜ì„¸ìš”!</p>
                <div id="villageArea"></div>
            </div>
        </div>

        <!-- ê³¨ë“œëª¨ìœ¼ê¸° íŒ¨ë„ -->
        <div id="panel4" class="panel">
            <div class="card">
                <h3 style="margin-bottom:20px;">ğŸ’° ê³¨ë“œëª¨ìœ¼ê¸°</h3>
                <div id="quizArea" style="padding:20px;text-align:center;">
                    <div id="quizQuestion" style="font-size:20px;margin-bottom:20px;font-weight:600;"></div>
                    <div id="quizOptions" style="display:grid;gap:10px;"></div>
                    <button class="btn" style="margin-top:20px;" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>
                </div>
            </div>
        </div>

        <!-- í†µê³„ íŒ¨ë„ -->
        <div id="panel5" class="panel">
            <div class="card">
                <h3 style="margin-bottom:15px;">ğŸ“Š í†µê³„</h3>
                <div id="statsArea"></div>
            </div>
            <div class="card" style="margin-top:15px;">
                <h3 style="margin-bottom:5px;">ğŸ“¦ ë‚´ ì œì‘ ìƒí’ˆ</h3>
                <p style="font-size:12px;color:#999;margin-bottom:15px;">íŒë§¤ ì¤‘ì¸ ìƒí’ˆê³¼ AI ë¦¬ë·°ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                <div id="myProductsList"></div>
            </div>
        </div>
    </div>

    <!-- Toast ì•Œë¦¼ -->
    <div id="toast" class="toast"></div>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="text-align:center;color:white;">
            <div style="font-size:60px;margin-bottom:15px;">ğŸ˜ï¸</div>
            <div style="font-size:22px;font-weight:700;margin-bottom:10px;">ìš°ë¦¬ë™ë„¤</div>
            <div style="font-size:14px;opacity:0.8;">ì„œë²„ ì—°ê²° ì¤‘...</div>
            <div style="margin-top:20px;width:40px;height:40px;border:3px solid rgba(255,255,255,0.3);border-top:3px solid white;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;"></div>
        </div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <!-- Firebase SDK (v9 compat) -->
        <audio id="bgmPlayer" loop preload="auto" style="display:none"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <!-- JavaScript íŒŒì¼ë“¤ import -->
    <script src="device-auth-firebase.js"></script>
    <script src="shop-data-30.js"></script>
    <script src="data-manager.js"></script>
    <script src="game-settings.js"></script>
    <script src="question-bank.js"></script>
    <script src="new-question-system.js"></script>
    <script src="smart-ai-buyers.js"></script>
    <script src="multi-shop-system.js"></script>
    <script src="review-system.js"></script>
    <script src="ranking-system.js"></script>
    <script>
        // ==================== ì „ì—­ ë³€ìˆ˜ ====================
        let currentUserKey = null; // ë‚´ë¶€ ì €ì¥ìš© í‚¤ (ì•„ì´ë””__UUID)
        let currentUsername = null; // í™”ë©´ í‘œì‹œìš© ì•„ì´ë””
        let userData = null;

        // ==================== ë°°ê²½ìŒì•…(BGM) ====================
        let _bgmStarted = false;
        function setupBgmPlayer() {
            const audio = document.getElementById('bgmPlayer');
            if (!audio) return;

            try {
                const enabled = GameSettings.getBgmEnabled && GameSettings.getBgmEnabled();
                const src = GameSettings.getBgmResolvedSrc ? GameSettings.getBgmResolvedSrc() : '';
                const vol = GameSettings.getBgmVolume ? GameSettings.getBgmVolume() : 0.35;

                if (!enabled || !src) {
                    audio.pause();
                    audio.removeAttribute('src');
                    audio.load();
                    return;
                }

                audio.src = src;
                audio.volume = vol;

                const tryPlay = () => {
                    if (_bgmStarted) return;
                    _bgmStarted = true;
                    audio.play().catch(() => { _bgmStarted = false; });
                };

                // ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì œí•œ ëŒ€ì‘: ì²« ì‚¬ìš©ì ì¸í„°ë™ì…˜ì— ì¬ìƒ
                document.addEventListener('click', tryPlay, { once: true });
                document.addEventListener('touchstart', tryPlay, { once: true });
            } catch (e) {
                // ignore
            }
        }
        // --- inventory helpers (ID alias + numeric parsing) ---
        function _canonicalIngId(id) {
            if (!id) return id;
            if (typeof id !== 'string') return id;
            const s = id.trim();
            if (s.startsWith('ing_')) return s.slice(4);
            return s;
        }

        // idê°€ í•œê¸€ ì´ë¦„(ì˜ˆ: 'ê¹€ì¹˜')ë¡œ ë“¤ì–´ì˜¤ëŠ” êµ¬ë²„ì „/í˜¼ì¬ ì¼€ì´ìŠ¤ ëŒ€ì‘:
        // 1) ìœ íš¨ idë©´ ê·¸ëŒ€ë¡œ
        // 2) 'ing_' ì ‘ë‘ ì œê±°
        // 3) ì¬ë£Œ nameê³¼ ì¼ì¹˜í•˜ë©´ í•´ë‹¹ idë¡œ ë³€í™˜
        function _resolveIngId(rawId) {
            const base = _canonicalIngId(rawId);
            try {
                const list = (DataManager && DataManager.getIngredients) ? (DataManager.getIngredients() || []) : [];
                // ìœ íš¨ idì¸ì§€ ë¹ ë¥´ê²Œ ì²´í¬
                if (list && list.length) {
                    const byId = list.find(x => x.id === base);
                    if (byId) return base;
                    const byName = list.find(x => x.name === base);
                    if (byName) return byName.id;
                }
            } catch (e) {}
            return base;
        }
        function _num(v) {
            if (v === null || v === undefined) return 0;
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
                const m = v.match(/\d+/);
                return m ? parseInt(m[0], 10) : 0;
            }
            return 0;
        }
        function getInvQty(id) {
            const inv = (userData && userData.inventory) ? userData.inventory : {};
            // idëŠ” ë³´í†µ ì˜ë¬¸ idì§€ë§Œ, êµ¬ë²„ì „ í˜¼ì¬ë¡œ í•œê¸€ëª…/ing_ì ‘ë‘/ê¸°íƒ€ê°€ ì„ì¼ ìˆ˜ ìˆìŒ
            const base = _resolveIngId(id);
            const pref = 'ing_' + base;

            // 1) ì •ìƒ id / êµ¬ë²„ì „ ing_ id í•©ì‚°
            let total = _num(inv[base]) + _num(inv[pref]);

            // 2) í˜¹ì‹œ ì›ë³¸ í‚¤ ê·¸ëŒ€ë¡œ(ì˜ˆ: 'ê¹€ì¹˜')ë¡œ ì €ì¥ëœ ê²½ìš°ë„ í•©ì‚°
            if (id && typeof id === 'string') {
                total += _num(inv[id]) + _num(inv['ing_' + id]);
            }

            // 3) ì¬ë£Œ name(í•œê¸€) í‚¤ë¡œ ì €ì¥ëœ ê²½ìš°ë„ í•©ì‚°
            try {
                const meta = (DataManager && DataManager.getIngredient) ? DataManager.getIngredient(base) : null;
                if (meta && meta.name) total += _num(inv[meta.name]);
            } catch (e) {}

            return total;
        }
        function decInvQty(id, amount) {
            const inv = (userData && userData.inventory) ? userData.inventory : {};
            const base = _resolveIngId(id);
            let need = _num(amount);

            // ë¨¼ì € base í‚¤ì—ì„œ ì°¨ê°
            const curBase = _num(inv[base]);
            const takeBase = Math.min(curBase, need);
            if (takeBase > 0) inv[base] = curBase - takeBase;
            need -= takeBase;

            // ë‚¨ìœ¼ë©´ ing_ í‚¤ì—ì„œ ì°¨ê°(êµ¬ë²„ì „ í˜¸í™˜)
            if (need > 0) {
                const prefKey = 'ing_' + base;
                const curPref = _num(inv[prefKey]);
                const takePref = Math.min(curPref, need);
                if (takePref > 0) inv[prefKey] = curPref - takePref;
                need -= takePref;
                if (_num(inv[prefKey]) === 0) delete inv[prefKey];
            }
        }
        // -------------------------------------------------------
        // -------------------------------------------------------

        let selectedAge = null;
        let currentProduct = null;
        let shoppingCart = {}; // {ingredientId: qty}
        let selectedMartCategory = 'all';
        let selectedBusiness = null;
        let currentQuestion = null;
        let currentPriceProduct = null;

        // ==================== ì´ˆê¸°í™” ====================
        window.addEventListener('DOMContentLoaded', function() {
            // Firebase ë°ì´í„° ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
            DeviceAuth.onReady(function() {
                // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
                document.getElementById('loadingScreen').style.display = 'none';
                // ë°°ê²½ìŒì•… ì„¸íŒ… (ì²« í´ë¦­ ì‹œ ìë™ ì¬ìƒ)
                setupBgmPlayer();

                
                // ì„¤ì • ê°’ ë¡œë“œí•˜ì—¬ UI ì—…ë°ì´íŠ¸
                updateCostDisplays();
                
                // Enter í‚¤ ì´ë²¤íŠ¸
                document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') document.getElementById('passwordInput').focus();
                });
                document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            });
            
            // 5ì´ˆ íƒ€ì„ì•„ì›ƒ (ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
            setTimeout(function() {
                document.getElementById('loadingScreen').style.display = 'none';
            }, 5000);
        });

        function updateCostDisplays() {
            const firstCost = GameSettings.getFirstShopCost();
            const addCost = GameSettings.getAdditionalShopCost();
            
            const firstEl = document.getElementById('firstShopCost');
            const addEl = document.getElementById('addShopCost');
            
            if (firstEl) firstEl.textContent = firstCost;
            if (addEl) addEl.textContent = addCost;
        }

        // ==================== Toast ====================
        function toast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // ==================== ë¡œê·¸ì¸ ====================
        // ê°„ë‹¨í•œ í•´ì‹œ (ë³´ì•ˆìš©ì´ ì•„ë‹Œ ê¸°ë³¸ ë³´í˜¸)
        function simpleHash(str) {
            let h = 0;
            for (let i = 0; i < str.length; i++) {
                h = ((h << 5) - h) + str.charCodeAt(i);
                h |= 0;
            }
            return 'h' + Math.abs(h).toString(36);
        }

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || username.length < 2) {
                toast('ì•„ì´ë””ëŠ” 2ê¸€ì ì´ìƒ');
                return;
            }
            if (!password || password.length < 4) {
                toast('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒ');
                return;
            }

            const pwHash = simpleHash(password);
            const users = DeviceAuth.getAllUsers();

            // âœ… UUID + ì•„ì´ë”” ê¸°ë°˜ ì‚¬ìš©ì í‚¤
            const uuid = (typeof DeviceAuth !== 'undefined' && DeviceAuth.getDeviceUUID) ? DeviceAuth.getDeviceUUID() : 'nouuid';
            const userKey = `${username}__${uuid}`;

            // â”€â”€ êµ¬ë²„ì „(ì•„ì´ë””ë§Œ í‚¤) ë°ì´í„°ê°€ ê°™ì€ ê¸°ê¸°ì—ì„œ ì¡´ì¬í•˜ë©´ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ â”€â”€
            if (!users[userKey] && users[username] && users[username].username === username) {
                users[userKey] = users[username];
                delete users[username];
                DeviceAuth.saveAllUsers(users);
            }

            if (users[userKey]) {
                // ê¸°ì¡´ ìœ ì € â†’ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                if (users[userKey].pwHash && users[userKey].pwHash !== pwHash) {
                    toast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤!');
                    return;
                }
                // ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ê¸°ì¡´ ìœ ì €ë©´ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
                if (!users[userKey].pwHash) {
                    users[userKey].pwHash = pwHash;
                    DeviceAuth.saveAllUsers(users);
                }
                currentUserKey = userKey;
                currentUsername = username;
                userData = users[userKey];
                // êµ¬ë²„ì „ ì¬ë£Œí‚¤ ì •ë¦¬(ing_ â†’ ìµœì‹ í‚¤)
                normalizeInventoryLegacyKeys();
                selectedAge = userData.age;
                document.getElementById('loginScreen').style.display = 'none';
                startGame();
                toast(`í™˜ì˜í•©ë‹ˆë‹¤, ${username}ë‹˜!`);
            } else {
                // ì‹ ê·œ ìœ ì €
                const initialGold = GameSettings.getInitialGold();
                users[userKey] = {
                    username: username,
                    userKey: userKey,
                    deviceUUID: uuid,
                    pwHash: pwHash,
                    gold: initialGold,
                    inventory: {},
                    products: [],
                    shop: null,
                    shops: [],
                    age: null,
                    stats: { made: 0, sold: 0, bought: 0 },
                    salesHistory: []
                };
                DeviceAuth.saveAllUsers(users);
                currentUserKey = userKey;
                currentUsername = username;
                userData = users[userKey];
                // êµ¬ë²„ì „ ì¬ë£Œí‚¤ ì •ë¦¬(ing_ â†’ ìµœì‹ í‚¤)
                normalizeInventoryLegacyKeys();
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('ageScreen').style.display = 'block';
                toast('íšŒì›ê°€ì… ì™„ë£Œ! ë‚˜ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”');
            }
        }

        // ==================== ë‚˜ì´ ì„ íƒ ====================
        function selectAge(age) {
            selectedAge = age;
            document.querySelectorAll('.age-btn').forEach(btn => btn.classList.remove('selected'));
            // eventê°€ ì—†ëŠ” í™˜ê²½ì—ì„œë„ ë™ì‘í•˜ë„ë¡ ì²˜ë¦¬
            try {
                const targetBtn = (typeof event !== 'undefined' && event.target) ? event.target.closest('.age-btn') : null;
                if (targetBtn) targetBtn.classList.add('selected');
            } catch(e) {}
            // í´ë¦­í•˜ë©´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ
            confirmAge();
        }

        function confirmAge() {
            // (ì˜µì…˜) ì§ì ‘ ì…ë ¥ ì¹¸ì´ ìˆì„ ë•Œë§Œ ë°˜ì˜
            const customEl = document.getElementById('customAge');
            const custom = customEl ? customEl.value : '';
            if (custom) selectedAge = parseInt(custom);
            if (!selectedAge || selectedAge < 5) {
                toast('ë‚˜ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            userData.age = selectedAge;
            DeviceAuth.saveUser(currentUserKey, userData);
            
            document.getElementById('ageScreen').style.display = 'none';
            startGame();
        }

        // ==================== ê²Œì„ ì‹œì‘ ====================
        function startGame() {
            try {
                createAIUsers();
            } catch (e) {
                console.log('AI ìœ ì € ìƒì„± ì—ëŸ¬:', e);
            }
            // AI êµ¬ë§¤(ì‡¼í•‘) ì‹œìŠ¤í…œ ì‹œì‘
            try {
                const interval = (typeof GameSettings !== 'undefined' && GameSettings.getAIPurchaseInterval)
                    ? GameSettings.getAIPurchaseInterval() : 30000;
                if (typeof SmartAIBuyers !== 'undefined' && SmartAIBuyers.startAIBuying) {
                    SmartAIBuyers.startAIBuying(interval);
                }
            } catch (e) {
                console.log('AI êµ¬ë§¤ ì‹œìŠ¤í…œ ì‹œì‘ ì—ëŸ¬:', e);
            }
            
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('displayUsername').textContent = currentUsername || '';
            updateCostDisplays();
            renderAll();
            
            try {
                nextQuestion();
            } catch (e) {
                console.log('ë¬¸ì œ ë¡œë“œ ì—ëŸ¬:', e);
            }
toast('ê²Œì„ ì‹œì‘!');
        }

        // ==================== AI ìœ ì € ìƒì„± (êµ¬ë§¤ì ì „ìš©, ë§¤ì¥ ì—†ìŒ) ====================
        function createAIUsers() {
            const users = DeviceAuth.getAllUsers();
            const aiNames = [
                'ê¹€ë¯¼ì¤€', 'ì´ì„œì¤€', 'ë°•ë„ìœ¤', 'ìµœì„œì—°', 'ì •ì§€ìš°',
                'í•œì˜ˆì€', 'ì˜¤ë¯¼ì„œ', 'ì¥í•˜ì¤€', 'ìœ¤ì„œì•„', 'ë°°ì¤€í˜',
                'ì†¡ì§€ë¯¼', 'ì„íƒœí˜„', 'ê°•ë‹¤ì€', 'ì¡°ì€ìš°', 'ì‹ í•˜ë¦°'
            ];
            
            aiNames.forEach(name => {
                const aiUsername = `AI_${name}`;
                if (!users[aiUsername]) {
                    // ì‹ ê·œ AI ìƒì„±
                    users[aiUsername] = {
                        username: aiUsername,
                        deviceId: 'AI',
                        isAI: true,
                        age: Math.floor(Math.random() * 10) + 10,
                        gold: Math.floor(Math.random() * 500) + 300,
                        inventory: {},
                        products: [],
                        shop: null,
                        shops: [],
                        stats: { made: 0, sold: 0, bought: 0 },
                        salesHistory: [],
                        createdAt: Date.now()
                    };
                } else if (users[aiUsername].shop) {
                    // ê¸°ì¡´ AIì— ë§¤ì¥ì´ ìˆìœ¼ë©´ ì œê±°
                    users[aiUsername].shop = null;
                    users[aiUsername].shops = [];
                    users[aiUsername].products = [];
                }
            });
            
            DeviceAuth.saveAllUsers(users);
        }

        // ==================== íƒ­ ì „í™˜ ====================
        function switchTab(idx) {
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === idx);
            });
            document.querySelectorAll('.panel').forEach((panel, i) => {
                panel.classList.toggle('active', i === idx);
            });

            // íƒ­ ì´ë™ ì‹œ í•­ìƒ ìƒë‹¨ë¶€í„° ë³´ì´ê²Œ
            try {
                const activePanel = document.querySelector('.panel.active');
                if (activePanel) activePanel.scrollTop = 0;
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
                window.scrollTo(0, 0);
            } catch (e) {}
        }

        // ==================== ì—…ì¢… ì„ íƒ ====================
        function openBusinessModal() {
            const cost = userData.shops && userData.shops.length > 0 
                ? GameSettings.getAdditionalShopCost()
                : GameSettings.getFirstShopCost();
                
            if (userData.gold < cost) {
                toast(`ê³¨ë“œ ë¶€ì¡±! (${cost}G í•„ìš”)`);
                return;
            }
            
            // ë™ì ìœ¼ë¡œ ì‹ë‹¹ ëª©ë¡ ë¡œë“œ (ì´ë¯¸ ë³´ìœ í•œ ì—…ì¢… ì œì™¸)
            const shopTypes = DataManager.getShopTypes();
            const ownedTypes = (userData.shops || []).map(s => s.type);
            const available = shopTypes.filter(s => !ownedTypes.includes(s.id));
            
            if (available.length === 0) {
                toast('ëª¨ë“  ì—…ì¢…ì„ ì´ë¯¸ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤!');
                return;
            }
            
            let html = '';
            available.forEach(shop => {
                html += `
                    <div class="business-btn" onclick="selectBusiness('${shop.id}')">
                        <div style="font-size:48px;margin-bottom:8px;">${shop.emoji}</div>
                        <div>${shop.name}</div>
                    </div>
                `;
            });
            document.getElementById('businessGrid').innerHTML = html;
            
            document.getElementById('businessModal').classList.add('show');
        }

        function closeBusinessModal() {
            document.getElementById('businessModal').classList.remove('show');
        }

        function selectBusiness(typeId) {
            const shopType = DataManager.getShopType(typeId);
            if (!shopType) {
                toast('ì‹ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì´ë¯¸ ë³´ìœ í•œ ì—…ì¢…ì¸ì§€ í™•ì¸
            const ownedTypes = (userData.shops || []).map(s => s.type);
            if (ownedTypes.includes(typeId)) {
                toast('ì´ë¯¸ ìš´ì˜ ì¤‘ì¸ ì—…ì¢…ì…ë‹ˆë‹¤!');
                return;
            }
            
            const cost = userData.shops && userData.shops.length > 0 
                ? GameSettings.getAdditionalShopCost()
                : GameSettings.getFirstShopCost();
            
            if (userData.gold < cost) {
                toast(`ê³¨ë“œ ë¶€ì¡±! (${cost}G í•„ìš”)`);
                return;
            }
            
            if (!userData.shops) userData.shops = [];
            
            const newShop = {
                type: typeId,
                name: `${currentUsername}ì˜ ${shopType.name}`,
                createdAt: Date.now()
            };
            
            userData.shop = newShop;
            userData.shops.push(newShop);
            userData.gold -= cost;
            
            DeviceAuth.saveUser(currentUserKey, userData);
            closeBusinessModal();
            toast(`${newShop.name} ì˜¤í”ˆ!`);
            renderAll();
        }

        function openAddShopModal() {
            // ì¶”ê°€ ìƒì  ë¹„ìš© í™•ì¸
            const cost = GameSettings.getAdditionalShopCost();
            if (userData.gold < cost) {
                toast(`ê³¨ë“œ ë¶€ì¡±! (${cost}G í•„ìš”)`);
                return;
            }
            
            // ì´ë¯¸ ë³´ìœ í•œ ì—…ì¢… í•„í„°ë§
            const ownedTypes = (userData.shops || []).map(s => s.type);
            const allTypes = DataManager.getShopTypes();
            const available = allTypes.filter(t => !ownedTypes.includes(t.id));
            
            if (available.length === 0) {
                toast('ëª¨ë“  ì—…ì¢…ì„ ì´ë¯¸ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤!');
                return;
            }
            
            let html = '';
            available.forEach(shop => {
                html += `
                    <div class="business-btn" onclick="addNewShop('${shop.id}')">
                        <div style="font-size:48px;margin-bottom:8px;">${shop.emoji}</div>
                        <div>${shop.name}</div>
                        <div style="font-size:11px;color:#999;margin-top:3px;">${cost}G</div>
                    </div>
                `;
            });
            document.getElementById('businessGrid').innerHTML = html;
            document.getElementById('businessModal').classList.add('show');
        }
        
        function addNewShop(typeId) {
            const result = MultiShopSystem.addShop(currentUserKey, typeId);
            if (result.success) {
                userData = DeviceAuth.getUser(currentUserKey);
                normalizeInventoryLegacyKeys();
                closeBusinessModal();
                toast(result.message);
                renderAll();
            } else {
                toast(result.message);
            }
        }

        function openShopSwitchModal() {
            const shops = MultiShopSystem.getShops(currentUserKey);
            
            if (shops.length <= 1) {
                toast('ìš´ì˜ ì¤‘ì¸ ìƒì ì´ 1ê°œë¿ì…ë‹ˆë‹¤');
                return;
            }
            
            const currentShop = userData.shop;
            
            let html = '<div style="display:grid;gap:10px;">';
            
            shops.forEach((shop, idx) => {
                const shopType = DataManager.getShopType(shop.type) || { emoji: 'ğŸª', name: shop.type || 'ì•Œ ìˆ˜ ì—†ìŒ' };
                const isActive = currentShop && shop.type === currentShop.type;
                html += `
                    <button 
                        class="btn" 
                        style="
                            padding:15px;text-align:left;display:flex;align-items:center;gap:15px;
                            ${isActive ? 
                                'background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:3px solid #667eea;' : 
                                'background:white;color:#333;border:2px solid #E0E0E0;'
                            }
                        "
                        onclick="quickSwitchShop(${idx})"
                    >
                        <div style="font-size:36px;">${shopType.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-size:15px;font-weight:700;margin-bottom:3px;">${shop.name}</div>
                            <div style="font-size:12px;${isActive ? 'opacity:0.9;' : 'color:#666;'}">${shopType.name}</div>
                        </div>
                        ${isActive ? '<div style="font-size:20px;">âœ“</div>' : ''}
                    </button>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('shopSwitchList').innerHTML = html;
            document.getElementById('shopSwitchModal').classList.add('show');
        }

        function closeShopSwitchModal() {
            document.getElementById('shopSwitchModal').classList.remove('show');
        }

        function quickSwitchShop(shopIndex) {
            const result = MultiShopSystem.switchShop(currentUserKey, shopIndex);
            
            if (result.success) {
                userData = DeviceAuth.getUser(currentUserKey);
                normalizeInventoryLegacyKeys();
                closeShopSwitchModal();
                toast(result.message);
                renderAll();
            } else {
                toast(result.message);
            }
        }

        // ==================== ì œì‘ ====================
        function selectProduct(id) {
            currentProduct = DataManager.getRecipe(id);
            if (!currentProduct) { toast('ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return; }
            
            renderProducts();
            document.getElementById('workArea').style.display = 'block';
            document.getElementById('previewEmoji').textContent = currentProduct.emoji;
            document.getElementById('previewName').textContent = currentProduct.name;
            
            let html = '';
            currentProduct.ingredients.forEach(ing => {
                const ingredientId = ing.ingredientId || ing.id;
                const have = getInvQty(ingredientId);
                const need = _num(ing.amount);
                const canMake = have >= need;
                
                const ingredient = DataManager.getIngredient(ingredientId) || ing;
                
                html += `
                    <div class="ingredient-item" style="background:${canMake?'#d4edda':'#f8d7da'};">
                        <span>${ingredient.emoji} ${ingredient.name}</span>
                        <span>${have} / ${need}ê°œ</span>
                    </div>
                `;
            });
            document.getElementById('ingredientList').innerHTML = html;

            // ë§Œë“¤ê¸° ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
            const canMakeAll = currentProduct.ingredients.every(ing => {
                const ingredientId = ing.ingredientId || ing.id;
                const have = getInvQty(ingredientId);
                return have >= _num(ing.amount);
            });
            const makeBtn = document.getElementById('makeBtn');
            if (makeBtn) {
                // ë²„íŠ¼ì€ í•­ìƒ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë‘ê³ , ë¶€ì¡±í•  ë•ŒëŠ” 'ì‹œê°ì 'ìœ¼ë¡œë§Œ ë¹„í™œì„±ì²˜ëŸ¼ ì²˜ë¦¬
                makeBtn.disabled = false;
                makeBtn.dataset.canMake = canMakeAll ? '1' : '0';
                makeBtn.style.opacity = canMakeAll ? '1' : '0.5';
            }

            // í˜„ì¬ ì„ íƒ ìƒí’ˆ ê¸°ì¤€ ì¥ë°”êµ¬ë‹ˆ(ë¶€ì¡±ë¶„) ì¤€ë¹„
            shoppingCart = buildMissingCartForProduct(currentProduct);
        }

        
        function buildMissingCartForProduct(product) {
            const cart = {};
            if (!product || !product.ingredients) return cart;
            product.ingredients.forEach(ing => {
                const ingredientId = ing.ingredientId || ing.id;
                const have = getInvQty(ingredientId);
                const need = _num(ing.amount);
                const missing = Math.max(0, need - have);
                if (missing > 0) cart[ingredientId] = missing;
            });
            return cart;
        }

        // êµ¬ë²„ì „ ì¬ë£ŒID(ì˜ˆ: ing_strawberry) â†’ ìµœì‹  ì¬ë£ŒID(strawberry) ìë™ ë³€í™˜
        function normalizeInventoryLegacyKeys() {
            // âš ï¸ ì´ í•¨ìˆ˜ëŠ” 'ì •ë¦¬'ë§Œ í•˜ê³ , ìë™ ì €ì¥ì€ í˜¸ì¶œìì—ì„œ í•˜ë„ë¡(ë¶€ì‘ìš© ìµœì†Œí™”)
            try {
                if (!userData || !userData.inventory) return false;
                const inv = userData.inventory;
                let keys = Object.keys(inv);
                if (keys.length === 0) return false;

                const list = (DataManager.getIngredients() || []);
                const valid = new Set(list.map(x => x.id));
                let changed = false;

                // ing_xxx â†’ xxx
                keys.forEach(k => {
                    if (!k || typeof k !== 'string') return;
                    if (k.startsWith('ing_')) {
                        const nk = k.replace(/^ing_/, '');
                        if (valid.has(nk)) {
                            inv[nk] = _num(inv[nk]) + _num(inv[k]);
                            delete inv[k];
                            changed = true;
                        }
                    }
                });

                // í•œê¸€ name í‚¤ â†’ id
                keys = Object.keys(inv);
                keys.forEach(k => {
                    if (!k || typeof k !== 'string') return;
                    if (valid.has(k)) return;
                    const hit = list.find(x => x.name === k);
                    if (hit && hit.id) {
                        inv[hit.id] = _num(inv[hit.id]) + _num(inv[k]);
                        delete inv[k];
                        changed = true;
                    }
                });

                return changed;
            } catch (e) {
                console.log('ì¬ë£ŒID ì •ê·œí™” ì—ëŸ¬:', e);
                return false;
            }
        }

        // í˜„ì¬ ì„ íƒí•œ ìƒí’ˆ ê¸°ì¤€ìœ¼ë¡œ ë¶€ì¡±ë¶„ì„ ì¥ë°”êµ¬ë‹ˆì— ë°”ë¡œ ë‹´ê¸° (ë§ˆíŠ¸ ë²„íŠ¼ìš©)
        function fillCartFromSelectedProduct() {
            if (!currentProduct) {
                toast('ë¨¼ì € ì œì‘í•  ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            shoppingCart = buildMissingCartForProduct(currentProduct);

            // ì¥ë°”êµ¬ë‹ˆ UIëŠ” í•­ìƒ ì—´ì–´ì¤€ë‹¤(ë¶€ì¡±ë¶„ì´ ì—†ì–´ë„ 'ë¹„ì–´ìˆìŒ' í‘œì‹œ)
            renderShop();
            const cartArea = document.getElementById('cartArea');
            if (cartArea) cartArea.style.display = 'block';

            if (Object.keys(shoppingCart).length === 0) {
                toast('ë¶€ì¡±í•œ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤');
            } else {
                toast('í•„ìš” ì¬ë£Œë¥¼ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤');
            }
        }


        function goShoppingForCurrentProduct() {
            if (!currentProduct) { toast('ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return; }
            shoppingCart = buildMissingCartForProduct(currentProduct);
            selectedMartCategory = 'all';
            switchTab(1);
            renderShop();
            if (Object.keys(shoppingCart).length === 0) {
                toast('ì´ë¯¸ ì¬ë£Œê°€ ì¶©ë¶„í•©ë‹ˆë‹¤!');
            } else {
                toast('í•„ìš” ì¬ë£Œë¥¼ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤');
            }
        }

function completeProduct() {
            try {
                if (!currentProduct) { toast('ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return; }

                // âœ… êµ¬ë²„ì „ ì €ì¥ë°ì´í„° í˜¸í™˜: products/stats ì—†ìœ¼ë©´ ìƒì„± (ì—¬ê¸°ì„œ ì˜¤ë¥˜ ë‚˜ì„œ 'ì œì‘ì™„ë£Œ'ê°€ ì•ˆ ëœ¨ëŠ” ì¼€ì´ìŠ¤ ë°©ì§€)
                if (!userData) { toast('ìœ ì € ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
                if (!Array.isArray(userData.products)) userData.products = [];
                if (!userData.stats) userData.stats = {};
                if (typeof userData.stats.made !== 'number') userData.stats.made = 0;

                // ì•ˆì „: êµ¬ë²„ì „ ì¬ë£Œí‚¤(ing_) ì •ë¦¬/ë³‘í•© (ìë™ ì €ì¥ X)
                normalizeInventoryLegacyKeys();

                // ì¬ë£Œ í™•ì¸ (ë¶€ì¡± í•­ëª©ì„ ì •í™•íˆ ì•Œë ¤ì£¼ê¸°)
                for (let ing of currentProduct.ingredients) {
                    const ingredientId = ing.ingredientId || ing.id;
                    const need = _num(ing.amount);
                    const have = getInvQty(ingredientId);
                    if (have < need) {
                        const meta = DataManager.getIngredient(ingredientId) || { name: ingredientId };
                        toast(`ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (${meta.name} ${have}/${need})`);
                        return;
                    }
                }

                // ì¬ë£Œ ì°¨ê°
                currentProduct.ingredients.forEach(ing => {
                    const ingredientId = ing.ingredientId || ing.id;
                    decInvQty(ingredientId, ing.amount);
                });

                // ì œì‘ íŒ¨ë„ ì¬ë Œë”(ë²„íŠ¼ ìƒíƒœ í¬í•¨) â€” ì‹¤íŒ¨í•´ë„ ì œì‘ì€ ê³„ì†ë˜ê²Œ
                try { selectProduct(currentProduct.id); } catch (e) { console.log('selectProduct ì˜¤ë¥˜(ë¬´ì‹œ):', e); }

                // ì ì •ê°€ê²© ê³„ì‚° (ì„¤ì •ì—ì„œ ë°°ìœ¨ ê°€ì ¸ì˜¤ê¸°)
                let fairPrice = 0;
                try { fairPrice = DataManager.calculateFairPrice(currentProduct.id); } catch (e) { fairPrice = 0; }
                if (!fairPrice || fairPrice < 0) fairPrice = 0;

                // ìƒí’ˆ ì¶”ê°€
                userData.products.push({
                    id: currentProduct.id,
                    name: currentProduct.name,
                    emoji: currentProduct.emoji,
                    price: fairPrice,
                    createdAt: Date.now()
                });

                userData.stats.made++;
                DeviceAuth.saveUser(currentUserKey, userData);

                toast('ì œì‘ ì™„ë£Œ!');
                currentProduct = null;
                const wa = document.getElementById('workArea');
                if (wa) wa.style.display = 'none';

                // ë¨¼ì € ë Œë”í•´ì„œ íŒë§¤ëª©ë¡ì´ ì¦‰ì‹œ ê°±ì‹ ë˜ê²Œ í•˜ê³ ,
                // ê·¸ ë‹¤ìŒ tick/frameì—ì„œ ë‚´ë§¤ì¥(íŒë§¤ì¤‘) íƒ­ ì´ë™ì„ í™•ì •í•œë‹¤.
                try { renderAll(); } catch (e) { console.log('renderAll ì˜¤ë¥˜(ë¬´ì‹œ):', e); }

                const goMyShop = () => {
                    try { switchTab(2); } catch (e) {}
                    try { window.scrollTo(0, 0); } catch (e) {}
                };
                goMyShop();
                setTimeout(goMyShop, 0);
                setTimeout(goMyShop, 50);
                try { requestAnimationFrame(goMyShop); } catch (e) {}
            } catch (e) {
                console.error('completeProduct ì¹˜ëª… ì˜¤ë¥˜:', e);
                toast('ì œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš” (ì½˜ì†” í™•ì¸)');
                try { renderAll(); } catch (e2) {}
            }
        }

        // ==================== ë§ˆíŠ¸ ====================
        function addToCart(ingredientId, qty=1) {
            shoppingCart[ingredientId] = (shoppingCart[ingredientId] || 0) + qty;
            renderShop();
        }

        function removeFromCart(ingredientId, qty=1) {
            const cur = shoppingCart[ingredientId] || 0;
            const next = Math.max(0, cur - qty);
            if (next === 0) delete shoppingCart[ingredientId];
            else shoppingCart[ingredientId] = next;
            renderShop();
        }

        function checkoutCart() {
            const ids = Object.keys(shoppingCart);
            if (ids.length === 0) { toast('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤'); return; }

            let total = 0;
            ids.forEach(id => {
                const ing = DataManager.getIngredient(id);
                if (ing) total += (ing.price || 0) * (shoppingCart[id] || 0);
            });

            if (userData.gold < total) {
                toast(`ê³¨ë“œ ë¶€ì¡±! í•„ìš”: ${total}G`);
                return;
            }

            userData.gold -= total;
            ids.forEach(id => {
                userData.inventory[id] = (userData.inventory[id] || 0) + (shoppingCart[id] || 0);
                userData.stats.bought += (shoppingCart[id] || 0);
            });

            shoppingCart = {};
            DeviceAuth.saveUser(currentUserKey, userData);
            toast('ê²°ì œ ì™„ë£Œ!');
            renderAll();
        }

        function buyIngredient(id, name, price, emoji) {
            if (userData.gold < price) {
                toast('ê³¨ë“œ ë¶€ì¡±!');
                return;
            }
            userData.gold -= price;
            userData.inventory[id] = (userData.inventory[id] || 0) + 1;
            userData.stats.bought++;
            DeviceAuth.saveUser(currentUserKey, userData);
            toast(`${name} êµ¬ë§¤!`);
            renderAll();
        }

        // ==================== ê°€ê²© ìˆ˜ì • ====================
        function showPriceModal(product, idx) {
            currentPriceProduct = { product, idx };
            const fairPrice = DataManager.calculateFairPrice(product.id);
            
            document.getElementById('priceProduct').innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:48px;">${product.emoji}</div>
                    <div style="font-size:18px;font-weight:600;margin-top:10px;">${product.name}</div>
                    <div style="font-size:14px;color:#666;margin-top:5px;">í˜„ì¬: ${userData.products[idx].price}G | ì ì •: ${fairPrice}G</div>
                </div>
            `;
            document.getElementById('newPrice').value = userData.products[idx].price;
            document.getElementById('priceModal').classList.add('show');
        }

        function closePriceModal() {
            document.getElementById('priceModal').classList.remove('show');
        }

        function updatePrice() {
            const newPrice = parseInt(document.getElementById('newPrice').value);
            if (!newPrice || newPrice < 1) {
                toast('ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            userData.products[currentPriceProduct.idx].price = newPrice;
            DeviceAuth.saveUser(currentUserKey, userData);
            closePriceModal();
            toast('ê°€ê²© ìˆ˜ì • ì™„ë£Œ!');
            renderAll();
        }

        // ==================== ëŒ“ê¸€ ====================
        function openCommentsModal(productId) {
            const comments = SmartAIBuyers.getComments(currentUserKey, productId);
            let html = '';
            if (comments.length === 0) {
                html = '<p style="text-align:center;color:#999;padding:20px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                comments.forEach(c => {
                    const colors = {
                        'ê°€ì„±ë¹„ ìµœê³ !': '#28a745',
                        'ì¢‹ì•„ìš”!': '#007bff',
                        'ë°°ê³ íŒŒì„œ ìƒ€ì–´ìš”': '#ffc107',
                        'ì¡°ê¸ˆ ë¹„ì‹¼ë°ìš”?': '#ff9800',
                        'ë„ˆë¬´ ë¹„ì‹¸ìš”!': '#dc3545',
                        'ë‚˜ì¤‘ì— ì˜¬ê²Œìš”': '#6c757d'
                    };
                    const color = colors[c.comment] || '#666';
                    html += `
                        <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;">
                            <div style="font-weight:600;color:#333;margin-bottom:5px;">${c.aiName}</div>
                            <div style="color:${color};font-size:14px;">${c.comment}</div>
                            <div style="font-size:11px;color:#999;margin-top:3px;">${new Date(c.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            document.getElementById('commentsContainer').innerHTML = html;
            document.getElementById('commentsModal').classList.add('show');
        }

        function closeCommentsModal() {
            document.getElementById('commentsModal').classList.remove('show');
        }

        // ==================== ë¬¸ì œ ====================
        function nextQuestion() {
            try {
                if (typeof QuestionSystem !== 'undefined' && QuestionSystem.getRandomQuestion) {
                    currentQuestion = QuestionSystem.getRandomQuestion(userData.age);
                } else {
                    // QuestionSystemì´ ì—†ìœ¼ë©´ DataManagerì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    currentQuestion = DataManager.getRandomQuestion();
                    // DataManager í˜•ì‹ì„ QuestionSystem í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    if (currentQuestion) {
                        currentQuestion = {
                            question: currentQuestion.question,
                            options: currentQuestion.options,
                            correctIndex: currentQuestion.correctIndex
                        };
                    }
                }
                
                if (!currentQuestion) {
                    // ê¸°ë³¸ ë¬¸ì œ
                    const defaultQuestions = [
                        { question: '2 + 2 = ?', options: ['4', '3', '5', '6'], correctIndex: 0 },
                        { question: '5 Ã— 3 = ?', options: ['15', '10', '20', '12'], correctIndex: 0 }
                    ];
                    currentQuestion = defaultQuestions[Math.floor(Math.random() * defaultQuestions.length)];
                }
                
                document.getElementById('quizQuestion').textContent = currentQuestion.question;
                
                let html = '';
                currentQuestion.options.forEach((option, idx) => {
                    html += `
                        <div class="quiz-option" 
                             style="padding:15px;background:#f8f9fa;border:2px solid #ddd;border-radius:10px;cursor:pointer;text-align:center;transition:all 0.3s;" 
                             onmouseover="this.style.background='#e9ecef';this.style.borderColor='#667eea';" 
                             onmouseout="this.style.background='#f8f9fa';this.style.borderColor='#ddd';"
                             onclick="checkAnswer(${idx})">
                            ${option}
                        </div>
                    `;
                });
                document.getElementById('quizOptions').innerHTML = html;
            } catch (e) {
                console.log('ë¬¸ì œ ë¡œë“œ ì—ëŸ¬:', e);
                document.getElementById('quizQuestion').textContent = 'ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                document.getElementById('quizOptions').innerHTML = '<p style="text-align:center;color:#999;">ë¬¸ì œ ì‹œìŠ¤í…œ ì˜¤ë¥˜</p>';
            }
        }

        function checkAnswer(idx) {
            if (idx === currentQuestion.correctIndex) {
                const reward = GameSettings.getQuestionReward('easy'); // ë‚œì´ë„ë³„ ë³´ìƒ
                userData.gold += reward;
                DeviceAuth.saveUser(currentUserKey, userData);
                toast(`ì •ë‹µ! +${reward}G`);
                renderAll();
                nextQuestion();
            } else {
                toast('ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”');
            }
        }

        // ==================== ë Œë”ë§ ====================
        function renderAll() {
            try {
                document.getElementById('gold').textContent = userData.gold;
                
                const hasShop = userData.shop && userData.shop.type;
                document.getElementById('noShopCard').style.display = hasShop ? 'none' : 'block';
                document.getElementById('hasShopArea').style.display = hasShop ? 'block' : 'none';
                
                if (hasShop) {
                    try { renderCraftingShopInfo(); } catch (e) { console.log('ì œì‘ ìƒì  ì •ë³´ ì—ëŸ¬:', e); }
                    try { renderCurrentShop(); } catch (e) { console.log('í˜„ì¬ ìƒì  ì—ëŸ¬:', e); }
                    try { renderProducts(); } catch (e) { console.log('ìƒí’ˆ ë Œë” ì—ëŸ¬:', e); }
                    try { renderShop(); } catch (e) { console.log('ë§ˆíŠ¸ ë Œë” ì—ëŸ¬:', e); }
                    try { renderCompleted(); } catch (e) { console.log('ì™„ì„± ìƒí’ˆ ì—ëŸ¬:', e); }
                    // ì„ íƒëœ ìƒí’ˆì´ ìˆìœ¼ë©´ ì¬ë£Œ ëª©ë¡ë„ ê°±ì‹ 
                    try { refreshSelectedProduct(); } catch (e) { console.log('ì„ íƒ ìƒí’ˆ ê°±ì‹  ì—ëŸ¬:', e); }
                }
                try { renderStats(); } catch (e) { console.log('í†µê³„ ì—ëŸ¬:', e); }
                try { renderMyProducts(); } catch (e) { console.log('ì œì‘ ë¦¬ìŠ¤íŠ¸ ì—ëŸ¬:', e); }
                try { renderVillage(); } catch (e) { console.log('ë§ˆì„ ì—ëŸ¬:', e); }
            } catch (e) {
                console.log('ë Œë”ë§ ì „ì²´ ì—ëŸ¬:', e);
            }
        }
        
        // ì„ íƒëœ ìƒí’ˆì˜ ì¬ë£Œ ë³´ìœ ëŸ‰ ì‹¤ì‹œê°„ ê°±ì‹ 
        function refreshSelectedProduct() {
            if (!currentProduct) { toast('ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”'); return; }
            const list = document.getElementById('ingredientList');
            if (!list || list.innerHTML === '') return;
            
            let html = '';
            currentProduct.ingredients.forEach(ing => {
                const ingredientId = ing.ingredientId || ing.id;
                const have = getInvQty(ingredientId);
                const need = _num(ing.amount);
                const canMake = have >= need;
                const ingredient = DataManager.getIngredient(ingredientId) || ing;
                
                html += `
                    <div class="ingredient-item" style="background:${canMake?'#d4edda':'#f8d7da'};">
                        <span>${ingredient.emoji} ${ingredient.name}</span>
                        <span>${have} / ${need}ê°œ</span>
                    </div>
                `;
            });
            list.innerHTML = html;

            // ë§Œë“¤ê¸° ë²„íŠ¼ë„ í•¨ê»˜ ê°±ì‹  (ë§ˆíŠ¸ì—ì„œ êµ¬ë§¤ í›„ ì œì‘ ë²„íŠ¼ì´ ê³„ì† ë¹„í™œì„±í™”ë˜ëŠ” ë¬¸ì œ í•´ê²°)
            const canMakeAll = currentProduct.ingredients.every(ing => {
                const ingredientId = ing.ingredientId || ing.id;
                const have = getInvQty(ingredientId);
                return have >= _num(ing.amount);
            });
            const makeBtn = document.getElementById('makeBtn');
            if (makeBtn) {
                // ë²„íŠ¼ì€ í•­ìƒ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë‘ê³ , ë¶€ì¡±í•  ë•ŒëŠ” 'ì‹œê°ì 'ìœ¼ë¡œë§Œ ë¹„í™œì„±ì²˜ëŸ¼ ì²˜ë¦¬
                makeBtn.disabled = false;
                makeBtn.dataset.canMake = canMakeAll ? '1' : '0';
                makeBtn.style.opacity = canMakeAll ? '1' : '0.5';
            }
        }

        function renderCraftingShopInfo() {
            try {
                const shops = (typeof MultiShopSystem !== 'undefined' && MultiShopSystem.getShops) 
                    ? MultiShopSystem.getShops(currentUserKey) 
                    : (userData.shops || (userData.shop ? [userData.shop] : []));
                const currentShop = userData.shop || shops[0];
                
                if (!currentShop) {
                    document.getElementById('craftingShopInfo').innerHTML = `
                        <div style="text-align:center;padding:15px;">
                            <div style="font-size:14px;opacity:0.9;">ìƒì ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                    return;
                }
                
                const shopType = DataManager.getShopType(currentShop.type) || { emoji: 'ğŸª', name: currentShop.type || 'ìƒì ' };
                
                document.getElementById('craftingShopInfo').innerHTML = `
                    <div style="display:flex;align-items:center;gap:15px;">
                        <div style="font-size:48px;">${shopType.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-size:16px;font-weight:700;margin-bottom:3px;">${currentShop.name}</div>
                            <div style="font-size:13px;opacity:0.9;">${shopType.name}</div>
                            ${shops.length > 1 ? `<div style="font-size:11px;opacity:0.7;margin-top:3px;">ì´ ${shops.length}ê°œ ìƒì  ìš´ì˜ ì¤‘</div>` : ''}
                        </div>
                    </div>
                `;
            } catch (e) {
                console.log('renderCraftingShopInfo ì—ëŸ¬:', e);
            }
        }

        function renderCurrentShop() {
            try {
                const shops = (typeof MultiShopSystem !== 'undefined' && MultiShopSystem.getShops) 
                    ? MultiShopSystem.getShops(currentUserKey) 
                    : (userData.shops || (userData.shop ? [userData.shop] : []));
                const currentShop = userData.shop || shops[0];
                
                if (!currentShop) {
                    document.getElementById('currentShopInfo').innerHTML = `
                        <div style="text-align:center;padding:20px;">
                            <div style="font-size:40px;margin-bottom:10px;">ğŸª</div>
                            <div style="font-size:14px;opacity:0.9;">ìš´ì˜ ì¤‘ì¸ ìƒì ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                    document.getElementById('shopSwitcher').innerHTML = '';
                    return;
                }
                
                const shopType = DataManager.getShopType(currentShop.type) || { emoji: 'ğŸª', name: currentShop.type || 'ìƒì ' };
                
                // í˜„ì¬ ìƒì  í‘œì‹œ
                document.getElementById('currentShopInfo').innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-size:48px;margin-bottom:10px;">${shopType.emoji}</div>
                        <div style="font-size:18px;font-weight:700;margin-bottom:5px;">${currentShop.name}</div>
                        <div style="font-size:13px;opacity:0.9;">${shopType.name}</div>
                    </div>
                `;
                
                // ìƒì  ì „í™˜ ë²„íŠ¼
                if (shops.length > 1) {
                    let html = `
                        <div style="border-top:1px solid rgba(255,255,255,0.2);margin-top:15px;padding-top:15px;">
                            <div style="font-size:13px;margin-bottom:10px;text-align:center;opacity:0.9;">
                                ë‹¤ë¥¸ ìƒì ìœ¼ë¡œ ì „í™˜ (ì´ ${shops.length}ê°œ ìš´ì˜ ì¤‘)
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;">
                    `;
                    
                    shops.forEach((shop, idx) => {
                        const st = DataManager.getShopType(shop.type) || { emoji: 'ğŸª', name: shop.type || 'ìƒì ' };
                        const isActive = currentShop && shop.type === currentShop.type;
                        html += `
                            <button 
                                class="btn" 
                                style="
                                    padding:12px 8px;font-size:13px;
                                    ${isActive ? 
                                        'background:white;color:#667eea;font-weight:700;border:2px solid white;' : 
                                        'background:rgba(255,255,255,0.2);color:white;border:2px solid transparent;'
                                    }
                                " 
                                onclick="switchCurrentShop(${idx})"
                            >
                                <div style="font-size:24px;margin-bottom:3px;">${st.emoji}</div>
                                <div style="font-size:11px;">${st.name}</div>
                                ${isActive ? '<div style="font-size:10px;margin-top:3px;">âœ“ ì„ íƒë¨</div>' : ''}
                            </button>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('shopSwitcher').innerHTML = html;
                } else {
                    document.getElementById('shopSwitcher').innerHTML = `
                        <div style="text-align:center;margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                            <div style="font-size:12px;opacity:0.7;">
                                ë” ë§ì€ ìƒì ì„ ìš´ì˜í•˜ë ¤ë©´ ìœ„ì˜ "+ ìƒì  ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.log('renderCurrentShop ì—ëŸ¬:', e);
                document.getElementById('currentShopInfo').innerHTML = '<p style="color:#999;padding:20px;text-align:center;">ìƒì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
            }
        }

        function switchCurrentShop(shopIndex) {
            const result = MultiShopSystem.switchShop(currentUserKey, shopIndex);
            
            if (result.success) {
                userData = DeviceAuth.getUser(currentUserKey);
                normalizeInventoryLegacyKeys();
                toast(result.message);
                renderAll();
            } else {
                toast(result.message);
            }
        }

        function renderProducts() {
            if (!userData.shop) return;
            
            // DataManagerì—ì„œ ë ˆì‹œí”¼ ê°€ì ¸ì˜¤ê¸°
            let recipes = DataManager.getRecipes(userData.shop.type);
            
            let html = '';
            recipes.forEach(p => {
                const selected = currentProduct && currentProduct.id === p.id;
                html += `
                    <div class="product-card ${selected?'selected':''}" onclick="selectProduct(${p.id})">
                        <div class="product-emoji">${p.emoji}</div>
                        <div class="product-name">${p.name}</div>
                    </div>
                `;
            });
            document.getElementById('productGrid').innerHTML = html;
        }

        function renderShop() {
            if (!userData) return;

            const ingredients = DataManager.getIngredients() || [];

             // 'ì¥ë°”êµ¬ë‹ˆì— ë°”ë¡œ ë‹´ê¸°' ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œ(ì„ íƒ ìƒí’ˆ ì—†ìœ¼ë©´ í´ë¦­ ì‹œ ì•ˆë‚´)
             const qc = document.getElementById('quickCartWrap');
             if (qc) qc.style.display = 'block';
            const categoryNames = {
                all: 'ì „ì²´',
                fruit: 'ê³¼ì¼',
                vegetable: 'ì±„ì†Œ',
                meat: 'ê³ ê¸°',
                seafood: 'í•´ì‚°ë¬¼',
                dairy: 'ìœ ì œí’ˆ',
                grain: 'ê³¡ë¬¼/ë¹µ',
                spice: 'í–¥ì‹ ë£Œ/ì–‘ë…',
                sauce: 'ì†ŒìŠ¤/ì¥ë¥˜',
                etc: 'ê¸°íƒ€'
            };

            // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ìƒì„±
            const categories = ['all', ...Array.from(new Set(ingredients.map(i => i.category || 'etc')))];
            const catButtons = categories.map(cat => {
                const active = (selectedMartCategory === cat);
                return `<button class="tab ${active ? 'active' : ''}" style="padding:10px 14px;border-radius:12px;font-size:13px;box-shadow:none;" onclick="setMartCategory('${cat}')">${categoryNames[cat] || cat}</button>`;
            }).join('');

            // ì¥ë°”êµ¬ë‹ˆ UI
            const cartArea = document.getElementById('cartArea');
            const cartIds = Object.keys(shoppingCart || {});
            if (cartArea) {
                if (cartIds.length === 0) {
                    cartArea.style.display = 'block';
                    cartArea.innerHTML = `<div style="padding:12px;border:1px dashed #cbd5e1;border-radius:12px;background:#f8fafc;color:#475569;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>`;
                } else {
                    let total = 0;
                    const rows = cartIds.map(id => {
                        const ing = DataManager.getIngredient(id);
                        const qty = shoppingCart[id] || 0;
                        const price = (ing?.price || 0) * qty;
                        total += price;
                        return `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid #eee;border-radius:12px;margin-top:8px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="font-size:20px;">${ing?.emoji || 'ğŸ§º'}</div>
                                    <div>
                                        <div style="font-weight:800;">${ing?.name || id}</div>
                                        <div style="font-size:12px;color:#777;">${ing?.price || 0}G Ã— ${qty} = <b>${price}G</b></div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:6px;">
                                    <button class="shop-btn" style="background:#f3f4f6;color:#333;" onclick="removeFromCart('${id}',1)">-</button>
                                    <button class="shop-btn" onclick="addToCart('${id}',1)">+</button>
                                </div>
                            </div>
                        `;
                    }).join('');

                    cartArea.style.display = 'block';
                    cartArea.innerHTML = `
                        <div style="background:#fff7e6;border:1px solid #ffe3b3;padding:14px;border-radius:15px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div style="font-weight:900;">ğŸ§º ì¥ë°”êµ¬ë‹ˆ</div>
                                <div style="font-size:13px;color:#555;">í•©ê³„ <b>${total}G</b></div>
                            </div>
                            ${rows}
                            <button class="btn" style="margin-top:12px;" onclick="checkoutCart()">ğŸ’³ ê²°ì œí•˜ê¸°</button>
                        </div>
                    `;
                }
            }

            // ì¹´í…Œê³ ë¦¬ íƒ­ ì¶œë ¥ (ë§ˆíŠ¸ ìƒë‹¨)
            let html = `<div class="tabs" style="margin-bottom:14px;">${catButtons}</div>`;

            const filtered = ingredients.filter(i => selectedMartCategory === 'all' ? true : (i.category || 'etc') === selectedMartCategory);

            filtered.forEach(ing => {
                const have = userData.inventory[ing.id] || 0;

                // ì„ íƒ ìƒí’ˆ ê¸°ì¤€ í•„ìš”/ë¶€ì¡± í‘œì‹œ
                let need = 0;
                let missing = 0;
                if (currentProduct) {
                    const x = currentProduct.ingredients.find(z => (z.ingredientId || z.id) === ing.id);
                    if (x) {
                        need = x.amount;
                        missing = Math.max(0, need - have);
                    }
                }
                const inCart = shoppingCart[ing.id] || 0;

                const highlight = (missing > 0 || inCart > 0) ? 'border:2px solid #ffb703;' : 'border:1px solid #eee;';
                const needBadge = need > 0
                    ? `<span style="margin-left:8px;font-size:12px;color:${have>=need?'#2e7d32':'#c62828'};">${have} / ${need}</span>`
                    : `<span style="margin-left:8px;font-size:12px;color:#888;">${have} / 0</span>`;

                html += `
                    <div class="shop-item" style="${highlight}">
                        <div class="shop-info">
                            <span class="shop-emoji">${ing.emoji}</span>
                            <div class="shop-details">
                                <div class="shop-name">${ing.name}</div>
                                <div class="shop-price">ğŸ’°${ing.price}G ${needBadge}</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="shop-btn" style="background:#f3f4f6;color:#333;" onclick="addToCart('${ing.id}',1)">ë‹´ê¸°${inCart>0?`(${inCart})`:''}</button>
                            <button class="shop-btn" onclick="buyIngredient('${ing.id}','${ing.name}',${ing.price},'${ing.emoji}')">ì¦‰ì‹œêµ¬ë§¤</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('shopList').innerHTML = html;
        }

        function setMartCategory(cat) {
            selectedMartCategory = cat;
            renderShop();
        }

        function renderCompleted() {
            // íŒë§¤ í†µê³„
            const salesHistory = userData.salesHistory || [];
            const totalSales = salesHistory.length;
            const totalRevenue = salesHistory.reduce((sum, sale) => sum + sale.price, 0);
            
            document.getElementById('salesStats').innerHTML = `
                <div style="background:linear-gradient(135deg,#4CAF50,#81C784);padding:20px;border-radius:15px;margin-bottom:20px;color:white;">
                    <div style="font-size:14px;font-weight:600;margin-bottom:15px;text-align:center;">ğŸ“Š íŒë§¤ ì‹¤ì </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                        <div style="text-align:center;background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;">
                            <div style="font-size:36px;font-weight:700;">${totalSales}</div>
                            <div style="font-size:13px;opacity:0.9;margin-top:5px;">íŒë§¤ ê°œìˆ˜</div>
                        </div>
                        <div style="text-align:center;background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;">
                            <div style="font-size:36px;font-weight:700;">${totalRevenue.toLocaleString()}</div>
                            <div style="font-size:13px;opacity:0.9;margin-top:5px;">ì´ ìˆ˜ìµ (G)</div>
                        </div>
                    </div>
                </div>
            `;
            
            // íŒë§¤ ì¤‘ì¸ ìƒí’ˆ
            let html = '';
            if (!userData.products || userData.products.length === 0) {
                html = `
                    <div style="text-align:center;padding:40px;background:#F5F5F5;border-radius:12px;">
                        <div style="font-size:48px;margin-bottom:15px;">ğŸ“¦</div>
                        <div style="font-size:16px;color:#666;margin-bottom:5px;">íŒë§¤ ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div style="font-size:13px;color:#999;">ì œì‘ íƒ­ì—ì„œ ìƒí’ˆì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>
                    </div>
                `;
            } else {
                html = '<div style="font-size:15px;font-weight:700;margin-bottom:15px;color:#333;">ğŸ“¦ íŒë§¤ ì¤‘ì¸ ìƒí’ˆ ('+userData.products.length+'ê°œ)</div>';
                
                userData.products.forEach((p, idx) => {
                    const fairPrice = DataManager.calculateFairPrice(p.id);
                    const comments = SmartAIBuyers.getComments(currentUserKey, p.id);
                    
                    html += `
                        <div class="shop-item" style="flex-direction:column;align-items:flex-start;">
                            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:10px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <span class="shop-emoji">${p.emoji}</span>
                                    <div class="shop-details" style="margin:0;">
                                        <div class="shop-name">${p.name}</div>
                                        <div class="shop-price">íŒë§¤ê°€: ${p.price}G (ì ì •: ${fairPrice}G)</div>
                                        ${comments.length > 0 ? `<div style="font-size:11px;color:#FF6B6B;margin-top:3px;">ğŸ’¬ AI ëŒ“ê¸€ ${comments.length}ê°œ</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;width:100%;">
                                <button class="shop-btn" onclick="showPriceModal(DataManager.getRecipe(${p.id}),${idx})">ê°€ê²© ìˆ˜ì •</button>
                                ${comments.length > 0 ? `<button class="shop-btn" style="background:#FF6B6B;" onclick="openCommentsModal(${p.id})">ëŒ“ê¸€ ${comments.length}</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('completedList').innerHTML = html;
        }

        // ==================== ë‚´ ì œì‘ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ + ë¦¬ë·° ====================
        function renderMyProducts() {
            const products = userData.products || [];
            const reviews = (typeof ReviewSystem !== 'undefined') ? ReviewSystem.getReviews(currentUserKey) : [];
            
            if (products.length === 0) {
                document.getElementById('myProductsList').innerHTML = `
                    <div style="text-align:center;padding:30px;color:#999;">
                        <div style="font-size:40px;margin-bottom:10px;">ğŸ“¦</div>
                        <div>ì•„ì§ ì œì‘í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            products.forEach((product, idx) => {
                // ì´ ìƒí’ˆì— ëŒ€í•œ ë¦¬ë·° í•„í„°ë§
                const productReviews = reviews.filter(r => r.productId === product.id);
                const stars = (rating) => 'â­'.repeat(Math.min(rating, 5));
                
                html += `
                    <div style="background:#f8f9fa;border-radius:12px;padding:15px;margin-bottom:12px;border:1px solid #eee;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                            <div style="font-size:36px;">${product.emoji}</div>
                            <div style="flex:1;">
                                <div style="font-size:15px;font-weight:700;">${product.name}</div>
                                <div style="font-size:13px;color:#667eea;font-weight:600;">${product.price}G</div>
                            </div>
                            <div style="font-size:11px;color:#999;">${new Date(product.createdAt).toLocaleDateString()}</div>
                        </div>
                `;
                
                // ë¦¬ë·° í‘œì‹œ
                if (productReviews.length > 0) {
                    html += `<div style="border-top:1px solid #eee;padding-top:8px;">`;
                    productReviews.forEach(review => {
                        const displayName = review.buyerUsername.startsWith('AI_') ? review.buyerUsername.replace('AI_','') : review.buyerUsername;
                        html += `
                            <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;padding:6px 8px;background:white;border-radius:8px;">
                                <div style="font-size:18px;">ğŸ’¬</div>
                                <div style="flex:1;">
                                    <div style="font-size:11px;color:#999;margin-bottom:2px;">${displayName} ${stars(review.rating)}</div>
                                    <div style="font-size:13px;">${review.text}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else {
                    html += `<div style="font-size:12px;color:#bbb;padding-top:5px;border-top:1px solid #eee;">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
                }
                
                html += `</div>`;
            });
            
            document.getElementById('myProductsList').innerHTML = html;
        }

        // ==================== ë§ˆì„ (ì¹œêµ¬ì™€ í•¨ê»˜ í•˜ê¸°) ====================
        function renderVillage() {
            const users = DeviceAuth.getAllUsers();
            let html = '';
            
            // ë‹¤ë¥¸ ì‹¤ì œ í”Œë ˆì´ì–´ ì¤‘ ë§¤ì¥ ìˆëŠ” ì‚¬ëŒë§Œ
            const otherPlayers = Object.keys(users).filter(name => {
                return name !== currentUserKey && !users[name].isAI && users[name].shop && users[name].shop.type;
            });
            
            if (otherPlayers.length === 0) {
                html = `
                    <div style="text-align:center;padding:40px 20px;">
                        <div style="font-size:60px;margin-bottom:15px;">ğŸ˜ï¸</div>
                        <div style="font-size:16px;font-weight:600;margin-bottom:8px;">ì•„ì§ ì´ì›ƒì´ ì—†ì–´ìš”</div>
                        <div style="font-size:13px;color:#888;">ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ë§¤ì¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤!</div>
                    </div>
                `;
            } else {
                html += `<div style="font-size:13px;color:#888;margin-bottom:12px;">ğŸ˜ï¸ ë§ˆì„ì— ${otherPlayers.length}ëª…ì˜ ì¹œêµ¬ê°€ ìˆìŠµë‹ˆë‹¤</div>`;
                
                otherPlayers.forEach(playerName => {
                    const player = users[playerName];
                    const shop = player.shop;
                    const st = DataManager.getShopType(shop.type) || { emoji: 'ğŸª', name: shop.type || 'ìƒì ' };
                    const productCount = (player.products || []).length;
                    
                    html += `
                        <div style="background:#f8f9fa;border-radius:12px;padding:15px;margin-bottom:10px;border:1px solid #eee;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="font-size:40px;">${st.emoji}</div>
                                <div style="flex:1;">
                                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
                                        <span style="font-size:15px;font-weight:700;">${shop.name}</span>
                                        <span style="font-size:10px;background:#28a745;color:white;padding:1px 6px;border-radius:8px;">ì¹œêµ¬</span>
                                    </div>
                                    <div style="font-size:12px;color:#666;">ì£¼ì¸: ${playerName}</div>
                                    <div style="font-size:12px;color:#999;margin-top:2px;">íŒë§¤ ì¤‘: ${productCount}ê°œ ìƒí’ˆ</div>
                                </div>
                                <button 
                                    class="btn" 
                                    style="width:auto;padding:10px 18px;font-size:13px;background:linear-gradient(135deg,#667eea,#764ba2);"
                                    onclick="visitShop('${playerName}')"
                                    ${productCount === 0 ? 'disabled style="width:auto;padding:10px 18px;font-size:13px;background:#ccc;cursor:not-allowed;"' : ''}
                                >
                                    ${productCount > 0 ? 'ğŸ›’ ë°©ë¬¸' : 'ì¤€ë¹„ ì¤‘'}
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // ê°™ì€ ê¸°ê¸° ì¹œêµ¬ ì´ˆëŒ€ ì•ˆë‚´
            html += `
                <div style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;border-radius:12px;padding:15px;margin-top:15px;text-align:center;">
                    <div style="font-size:24px;margin-bottom:8px;">ğŸ‘«</div>
                    <div style="font-size:14px;font-weight:700;margin-bottom:5px;">ì¹œêµ¬ì™€ í•¨ê»˜ í•˜ê¸°</div>
                    <div style="font-size:12px;opacity:0.9;">ì„œë¡œì˜ ìƒì ì„ ë°©ë¬¸í•˜ê³  ìƒí’ˆì„ êµ¬ë§¤í•  ìˆ˜ ìˆì–´ìš”!</div>
                </div>
            `;
            
            document.getElementById('villageArea').innerHTML = html;
        }

        function visitShop(ownerName) {
            const users = DeviceAuth.getAllUsers();
            const owner = users[ownerName];
            if (!owner || !owner.products || owner.products.length === 0) {
                toast('íŒë§¤ ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const shop = owner.shop;
            const st = DataManager.getShopType(shop.type) || { emoji: 'ğŸª', name: shop.type || 'ìƒì ' };
            const displayName = owner.isAI ? ownerName.replace('AI_', '') : ownerName;
            
            document.getElementById('visitTitle').innerHTML = `${st.emoji} ${shop.name}`;
            
            let html = `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:13px;color:#666;">ì£¼ì¸: ${displayName} | ${st.name}</div>
                </div>
                <div style="display:grid;gap:10px;">
            `;
            
            owner.products.forEach((product, idx) => {
                const canBuy = userData.gold >= product.price;
                html += `
                    <div style="background:#f8f9fa;border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px;border:1px solid ${canBuy ? '#ddd' : '#ffcccb'};">
                        <div style="font-size:36px;">${product.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-size:14px;font-weight:600;">${product.name}</div>
                            <div style="font-size:16px;font-weight:700;color:#667eea;margin-top:2px;">${product.price}G</div>
                        </div>
                        <button 
                            class="btn" 
                            style="width:auto;padding:8px 16px;font-size:13px;${canBuy ? 'background:linear-gradient(135deg,#28a745,#20c997);' : 'background:#ccc;cursor:not-allowed;'}"
                            onclick="${canBuy ? `buyFromFriend('${ownerName}', ${idx})` : ''}"
                            ${canBuy ? '' : 'disabled'}
                        >
                            ${canBuy ? 'êµ¬ë§¤' : 'ê³¨ë“œ ë¶€ì¡±'}
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (owner.products.length === 0) {
                html = '<div style="text-align:center;padding:20px;color:#999;">íŒë§¤ ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
            
            document.getElementById('visitContent').innerHTML = html;
            document.getElementById('visitModal').classList.add('show');
        }

        function buyFromFriend(ownerName, productIdx) {
            const users = DeviceAuth.getAllUsers();
            const owner = users[ownerName];
            
            if (!owner || !owner.products || !owner.products[productIdx]) {
                toast('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const product = owner.products[productIdx];
            
            if (userData.gold < product.price) {
                toast('ê³¨ë“œ ë¶€ì¡±!');
                return;
            }
            
            // êµ¬ë§¤ì: ê³¨ë“œ ì°¨ê°
            userData.gold -= product.price;
            userData.stats.bought = (userData.stats.bought || 0) + 1;
            DeviceAuth.saveUser(currentUserKey, userData);
            
            // íŒë§¤ì: ê³¨ë“œ ì¶”ê°€ + ìƒí’ˆ ì œê±° + íŒë§¤ê¸°ë¡
            owner.gold += product.price;
            owner.stats.sold = (owner.stats.sold || 0) + 1;
            if (!owner.salesHistory) owner.salesHistory = [];
            owner.salesHistory.push({
                productName: product.name,
                buyer: currentUsername,
                price: product.price,
                soldAt: Date.now()
            });
            owner.products.splice(productIdx, 1);
            users[ownerName] = owner;
            DeviceAuth.saveAllUsers(users);
            
            // ë¦¬ë·° ì¶”ê°€
            try {
                if (typeof ReviewSystem !== 'undefined' && ReviewSystem.addReview) {
                    ReviewSystem.addReview(ownerName, product.id, currentUsername);
                }
            } catch(e) { console.log('ë¦¬ë·° ì—ëŸ¬:', e); }
            
            // UI ì—…ë°ì´íŠ¸
            toast(`${product.name} êµ¬ë§¤ ì™„ë£Œ! (-${product.price}G)`);
            closeVisitModal();
            renderAll();
        }

        function closeVisitModal() {
            document.getElementById('visitModal').classList.remove('show');
        }

        function renderStats() {
            const stats = userData.stats || {made:0,sold:0,bought:0};
            const salesHistory = userData.salesHistory || [];
            const totalRevenue = salesHistory.reduce((sum, sale) => sum + sale.price, 0);
            
            let html = `
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:20px;">
                    <div style="text-align:center;background:#f8f9fa;padding:20px;border-radius:12px;">
                        <div style="font-size:36px;font-weight:700;color:#667eea;">${stats.made}</div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">ì œì‘</div>
                    </div>
                    <div style="text-align:center;background:#f8f9fa;padding:20px;border-radius:12px;">
                        <div style="font-size:36px;font-weight:700;color:#28a745;">${salesHistory.length}</div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">íŒë§¤</div>
                    </div>
                    <div style="text-align:center;background:#f8f9fa;padding:20px;border-radius:12px;">
                        <div style="font-size:36px;font-weight:700;color:#ffc107;">${stats.bought}</div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">êµ¬ë§¤</div>
                    </div>
                    <div style="text-align:center;background:#f8f9fa;padding:20px;border-radius:12px;">
                        <div style="font-size:36px;font-weight:700;color:#dc3545;">${totalRevenue.toLocaleString()}</div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">ì´ ìˆ˜ìµ (G)</div>
                    </div>
                </div>
            `;
            
            // íŒë§¤ ë‚´ì—­
            if (salesHistory.length > 0) {
                html += `
                    <div style="margin-top:20px;">
                        <h4 style="margin-bottom:10px;">ğŸ“‹ íŒë§¤ ë‚´ì—­ (ìµœê·¼ 10ê°œ)</h4>
                        ${salesHistory.slice(-10).reverse().map(s => `
                            <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-weight:600;">${s.productName}</div>
                                        <div style="font-size:13px;color:#666;">${s.buyer}ë‹˜ê»˜ íŒë§¤</div>
                                    </div>
                                    <div style="font-size:18px;font-weight:700;color:#28a745;">+${s.price}G</div>
                                </div>
                                <div style="font-size:11px;color:#999;margin-top:5px;">${new Date(s.soldAt).toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('statsArea').innerHTML = html;
        }

        console.log('âœ… ìš°ë¦¬ë™ë„¤ ê²Œì„ ë¡œë“œ ì™„ë£Œ!');
    </script>
</body>
</html>
