<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ë™ë„¤ - ê´€ë¦¬ì</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 { 
            font-size: 32px; 
            color: #333; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .subtitle { color: #666; font-size: 14px; }
        
        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 15px 25px;
            background: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab:hover { transform: translateY(-2px); }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        /* íŒ¨ë„ */
        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .panel.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover { transform: translateY(-2px); }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        /* ì¹´ë“œ */
        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        /* í…Œì´ë¸” */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 700;
            color: #333;
        }
        
        /* ì…ë ¥ */
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            z-index: 10000;
            display: none;
        }
        
        .toast.show { display: block; }
        
        /* ê·¸ë¦¬ë“œ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        /* ì•„ì´í…œ */
        .item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #ddd;
            transition: all 0.3s;
        }
        
        .item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .item-emoji {
            font-size: 36px;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 3px;
        }
        
        .item-desc {
            font-size: 13px;
            color: #666;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* ì„¤ì • ê·¸ë¦¬ë“œ */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .setting-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        
        .setting-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .setting-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #5568d3;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* ì¬ë£Œ ì¹´í…Œê³ ë¦¬ */
        .category-section {
            margin-bottom: 30px;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
        }
    
        /* ê´€ë¦¬ì ì ê¸ˆ */
        .admin-lock {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        .admin-lock .box {
            width: 100%;
            max-width: 420px;
            background: white;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
        }
        .admin-lock h2 { font-size: 20px; margin-bottom: 8px; color:#222; }
        .admin-lock p { font-size: 13px; color:#666; margin-bottom: 16px; line-height:1.4; }
        .admin-lock input {
            width: 100%;
            padding: 14px 14px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
        }
        .admin-lock .row { display:flex; gap:10px; margin-top:12px; }
        .admin-lock .btn {
            flex:1;
            border:none;
            border-radius: 12px;
            padding: 12px 14px;
            font-weight: 700;
            cursor:pointer;
        }
        .admin-lock .btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .admin-lock .btn.ghost {
            background: #f3f4f6;
            color:#333;
        }
        .admin-lock .error { margin-top:10px; color:#dc3545; font-size:13px; display:none; }
    </style>
</head>
<body>
    <!-- ê´€ë¦¬ì ì ê¸ˆ -->
    <div id="adminLock" class="admin-lock">
        <div class="box">
            <h2>ğŸ”’ ê´€ë¦¬ì í˜ì´ì§€</h2>
            <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ê´€ë¦¬ì í™”ë©´ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>â€» ì´ ë°©ì‹ì€ ë°ëª¨ìš©ì…ë‹ˆë‹¤. ë°°í¬ ì‹œ ë¹„ë°€ë²ˆí˜¸ëŠ” ê¼­ ë³€ê²½í•˜ì„¸ìš”.</p>
            <input id="adminPasswordInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" />
            <div class="row">
                <button class="btn ghost" onclick="location.href='index.html'">ê²Œì„ìœ¼ë¡œ</button>
                <button class="btn primary" onclick="unlockAdmin()">ì…ì¥</button>
            </div>
            <div id="adminLockError" class="error">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.</div>
        </div>
    </div>

    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>
                <span>ğŸ˜ï¸</span>
                <span>ìš°ë¦¬ë™ë„¤ ê´€ë¦¬ì</span>
            </h1>
            <p class="subtitle">ê²Œì„ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ê³  ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>

        <!-- íƒ­ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="switchTab(1)">ğŸ‘¥ ìœ ì € ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab(2)">âš™ï¸ ê²Œì„ ì„¤ì •</button>
            <button class="tab" onclick="switchTab(3)">ğŸª ì‹ë‹¹ ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab(4)">ğŸ§ª ì¬ë£Œ ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab(5)">ğŸ“‹ ë ˆì‹œí”¼ ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab(6)">ğŸ’° ë¬¸ì œ ê´€ë¦¬</button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ íŒ¨ë„ -->
        <div id="panel0" class="panel active">
            <div class="card-header">
                <div class="card-title">ğŸ“Š ë°ì´í„° í˜„í™©</div>
                <button class="btn btn-danger" onclick="if(confirm('ëª¨ë“  ê²Œì„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ê³„ì†?')){localStorage.clear();location.reload();}">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
            <div id="dashboardArea" style="margin-top:20px;"></div>
        </div>

        <!-- ìœ ì € ê´€ë¦¬ íŒ¨ë„ -->
        <div id="panel1" class="panel">
            <div class="card-header">
                <div class="card-title">ğŸ“Š ì „ì²´ ìœ ì € ëª©ë¡</div>
                <button class="btn" onclick="loadUsers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="usersList"></div>
        </div>

        <!-- ê²Œì„ ì„¤ì • íŒ¨ë„ -->
        <div id="panel2" class="panel">
            <div class="card-header">
                <div class="card-title">âš™ï¸ ê²Œì„ ì„¤ì •</div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-secondary" onclick="resetSettings()">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
                    <button class="btn" onclick="saveSettings()">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
            
            <div class="settings-grid" id="settingsGrid"></div>
            <div style="margin-top:18px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,0.08);">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                    <div style="font-size:18px;font-weight:800;color:#333;">ğŸµ ë°°ê²½ìŒì•… ëª¨ë“ˆ</div>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:700;color:#333;">
                        <input type="checkbox" id="bgm_enabled" />
                        ì‚¬ìš©
                    </label>
                </div>

                <div style="display:grid;grid-template-columns: 140px 1fr;gap:12px;margin-top:12px;align-items:center;">
                    <div style="font-weight:700;color:#444;">ì†ŒìŠ¤ ë°©ì‹</div>
                    <select id="bgm_sourceType" style="padding:10px;border:1px solid #ddd;border-radius:12px;">
                        <option value="url">URL</option>
                        <option value="data">íŒŒì¼ ì—…ë¡œë“œ(ì´ ê¸°ê¸°)</option>
                    </select>

                    <div style="font-weight:700;color:#444;">BGM URL</div>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                        <input type="text" id="bgm_url" placeholder="ì˜ˆ: https://.../bgm.mp3" style="padding:10px;border:1px solid #ddd;border-radius:12px;min-width:280px;flex:1;" />
                        <button class="btn" onclick="bgmAddUrl()">â• URLì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¶”ê°€</button>
                    </div>

                    <div style="font-weight:700;color:#444;">íŒŒì¼ ì¶”ê°€</div>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                        <input type="file" id="bgm_file" accept="audio/*" />
                        <button class="btn" onclick="bgmAddFile()">â• íŒŒì¼ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¶”ê°€</button>
                        <span style="font-size:12px;color:#666;">â€» ì—…ë¡œë“œ íŒŒì¼ì€ ì´ ê¸°ê¸°(localStorage)ì— ì €ì¥ë©ë‹ˆë‹¤. í° íŒŒì¼(ìˆ˜ MB ì´ìƒ)ì€ ì €ì¥ ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ìš”.</span>
                    </div>

                    <div style="font-weight:700;color:#444;">ë³¼ë¥¨</div>
                    <input type="range" id="bgm_volume" min="0" max="1" step="0.01" />

                    <div style="font-weight:700;color:#444;">ë¯¸ë¦¬ë“£ê¸°</div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button class="btn btn-secondary" onclick="bgmPreview()">â–¶ï¸ ì¬ìƒ</button>
                        <button class="btn btn-secondary" onclick="bgmStopPreview()">â¹ ì •ì§€</button>
                    </div>

                    <div style="font-weight:700;color:#444;">ë¼ì´ë¸ŒëŸ¬ë¦¬</div>
                    <div id="bgm_library" style="display:flex;flex-direction:column;gap:8px;"></div>
                </div>

                <audio id="bgm_preview_player" controls style="width:100%;margin-top:12px;display:none;"></audio>

                <!-- ìˆ¨ê¹€ í•„ë“œ(ì—…ë¡œë“œ íŒŒì¼ ì„ íƒ ì‹œ ì‚¬ìš©) -->
                <input type="hidden" id="bgm_dataKey" value="" />
            </div>

        </div>

        <!-- ì‹ë‹¹ ê´€ë¦¬ íŒ¨ë„ -->
        <div id="panel3" class="panel">
            <div class="card-header">
                <div class="card-title">ğŸª ì‹ë‹¹ ì¢…ë¥˜ ê´€ë¦¬</div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-success" onclick="openAddShopTypeModal()">+ ìƒˆ ì‹ë‹¹ ì¶”ê°€</button>
                    <button class="btn" onclick="openUploadModal('shops')">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                </div>
            </div>
            <div class="grid" id="shopTypesList"></div>
        </div>

        <!-- ì¬ë£Œ ê´€ë¦¬ íŒ¨ë„ -->
        <div id="panel4" class="panel">
            <div class="card-header">
                <div class="card-title">ğŸ§ª ì¬ë£Œ ê´€ë¦¬</div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-success" onclick="openAddIngredientModal()">+ ìƒˆ ì¬ë£Œ ì¶”ê°€</button>
                    <button class="btn" onclick="openUploadModal('ingredients')">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                </div>
            </div>
            <div id="ingredientsList"></div>
        </div>

        <!-- ë ˆì‹œí”¼ ê´€ë¦¬ íŒ¨ë„ -->
        <div id="panel5" class="panel">
            <div class="card-header">
                <div class="card-title">ğŸ“‹ ë ˆì‹œí”¼ ê´€ë¦¬</div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-success" onclick="openAddRecipeModal()">+ ìƒˆ ë ˆì‹œí”¼ ì¶”ê°€</button>
                    <button class="btn" onclick="openUploadModal('recipes')">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                </div>
            </div>
            <div id="recipesList"></div>
        </div>

        <!-- ë¬¸ì œ ê´€ë¦¬ íŒ¨ë„ -->
        <div id="panel6" class="panel">
            <div class="card-header">
                <div class="card-title">ğŸ’° ë¬¸ì œ ê´€ë¦¬</div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-success" onclick="openAddQuestionModal()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button>
                    <button class="btn" onclick="openUploadModal('questions')">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                </div>
            </div>
            <div id="questionsList"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="modal" class="modal"></div>

    <!-- JavaScript -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="device-auth-firebase.js"></script>
    <script src="shop-data-30.js"></script>
    <script src="data-manager.js"></script>
    <script src="game-settings.js"></script>
    <script>
        // ==================== ì „ì—­ ë³€ìˆ˜ ====================
        let currentEditItem = null;
        let currentUploadType = null;

        // ==================== ì´ˆê¸°í™” ====================
        window.addEventListener('DOMContentLoaded', function() {
            // Firebase ë°ì´í„° ë¡œë“œ ëŒ€ê¸°
            if (DeviceAuth.onReady) {
                DeviceAuth.onReady(initAdmin);
                setTimeout(initAdmin, 5000); // íƒ€ì„ì•„ì›ƒ
            } else {
                initAdmin();
            }
        });
        
        let _adminInited = false;
        function initAdmin() {
            if (_adminInited) return;
            _adminInited = true;
            loadDashboard();
            loadUsers();
            loadSettings();
            loadShopTypes();
            loadIngredients();
            loadRecipes();
            loadQuestions();
        }

        // ==================== Toast ====================
        function toast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // ==================== íƒ­ ì „í™˜ ====================
        function switchTab(idx) {
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === idx);
            });
            document.querySelectorAll('.panel').forEach((panel, i) => {
                panel.classList.toggle('active', i === idx);
            });
            if (idx === 2) { try { renderSettings(); renderBgmModule(); } catch(e) {} }
        }

        // ==================== ëª¨ë‹¬ ====================
        function showModal(html) {
            document.getElementById('modal').innerHTML = `
                <div class="modal-content">
                    ${html}
                </div>
            `;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        // ==================== ëŒ€ì‹œë³´ë“œ ====================
        function loadDashboard() {
            const users = DeviceAuth.getAllUsers();
            const shopTypes = DataManager.getShopTypes();
            const ingredients = DataManager.getIngredients();
            const recipes = DataManager.getRecipes();
            const questions = DataManager.getQuestions();
            
            const allUsers = Object.values(users);
            const realUsers = allUsers.filter(u => !u.isAI);
            const aiUsers = allUsers.filter(u => u.isAI);
            const totalGold = allUsers.reduce((s, u) => s + (u.gold || 0), 0);
            const totalProducts = allUsers.reduce((s, u) => s + (u.products || []).length, 0);
            const totalSales = allUsers.reduce((s, u) => s + (u.salesHistory || []).length, 0);
            
            // ì—…ì¢…ë³„ ë ˆì‹œí”¼ ìˆ˜
            let shopRecipeHtml = '';
            shopTypes.forEach(shop => {
                const count = recipes.filter(r => r.shopType === shop.id).length;
                shopRecipeHtml += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f8f9fa;border-radius:8px;margin-bottom:4px;">
                        <span>${shop.emoji} ${shop.name}</span>
                        <span style="font-weight:700;color:#667eea;">${count}ê°œ</span>
                    </div>
                `;
            });
            
            document.getElementById('dashboardArea').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:30px;">
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:25px;border-radius:16px;text-align:center;">
                        <div style="font-size:36px;font-weight:700;">${shopTypes.length}</div>
                        <div style="font-size:14px;opacity:0.9;margin-top:5px;">ğŸª ì—…ì¢…</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:25px;border-radius:16px;text-align:center;">
                        <div style="font-size:36px;font-weight:700;">${recipes.length}</div>
                        <div style="font-size:14px;opacity:0.9;margin-top:5px;">ğŸ“‹ ë ˆì‹œí”¼</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#ffc107,#ff8c00);color:white;padding:25px;border-radius:16px;text-align:center;">
                        <div style="font-size:36px;font-weight:700;">${ingredients.length}</div>
                        <div style="font-size:14px;opacity:0.9;margin-top:5px;">ğŸ§ª ì¬ë£Œ</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#dc3545,#e83e8c);color:white;padding:25px;border-radius:16px;text-align:center;">
                        <div style="font-size:36px;font-weight:700;">${questions.length}</div>
                        <div style="font-size:14px;opacity:0.9;margin-top:5px;">ğŸ’° ë¬¸ì œ</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#17a2b8,#6610f2);color:white;padding:25px;border-radius:16px;text-align:center;">
                        <div style="font-size:36px;font-weight:700;">${realUsers.length}</div>
                        <div style="font-size:14px;opacity:0.9;margin-top:5px;">ğŸ‘¤ ì‹¤ì œ ìœ ì €</div>
                    </div>
                    <div style="background:linear-gradient(135deg,#6c757d,#495057);color:white;padding:25px;border-radius:16px;text-align:center;">
                        <div style="font-size:36px;font-weight:700;">${aiUsers.length}</div>
                        <div style="font-size:14px;opacity:0.9;margin-top:5px;">ğŸ¤– AI ìœ ì €</div>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
                    <div>
                        <h3 style="margin-bottom:15px;">ğŸª ì—…ì¢…ë³„ ë ˆì‹œí”¼ í˜„í™©</h3>
                        <div style="max-height:500px;overflow-y:auto;">${shopRecipeHtml}</div>
                    </div>
                    <div>
                        <h3 style="margin-bottom:15px;">ğŸ’° ê²½ì œ í˜„í™©</h3>
                        <div style="display:grid;gap:8px;">
                            <div style="padding:12px;background:#f8f9fa;border-radius:8px;display:flex;justify-content:space-between;">
                                <span>ì „ì²´ ë³´ìœ  ê³¨ë“œ</span><span style="font-weight:700;">${totalGold.toLocaleString()}G</span>
                            </div>
                            <div style="padding:12px;background:#f8f9fa;border-radius:8px;display:flex;justify-content:space-between;">
                                <span>ë“±ë¡ëœ ìƒí’ˆ</span><span style="font-weight:700;">${totalProducts}ê°œ</span>
                            </div>
                            <div style="padding:12px;background:#f8f9fa;border-radius:8px;display:flex;justify-content:space-between;">
                                <span>ì´ ê±°ë˜ íšŸìˆ˜</span><span style="font-weight:700;">${totalSales}ê±´</span>
                            </div>
                        </div>
                        
                        <h3 style="margin:20px 0 15px;">ğŸ”§ ë¹ ë¥¸ ì‘ì—…</h3>
                        <div style="display:grid;gap:8px;">
                            <button class="btn" onclick="DataManager.resetToDefault();location.reload();" style="text-align:left;">ğŸ”„ ê²Œì„ ë°ì´í„° ë¦¬ì…‹ (ì‹ë‹¹/ì¬ë£Œ/ë ˆì‹œí”¼ ì´ˆê¸°í™”)</button>
                            <button class="btn btn-secondary" onclick="exportAllData()" style="text-align:left;">ğŸ“¤ ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON)</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function exportAllData() {
            const json = DataManager.exportData();
            const blob = new Blob([json], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'game-data-export.json';
            a.click();
            toast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
        }

        // ==================== ìœ ì € ê´€ë¦¬ ====================
        function loadUsers() {
            const users = DeviceAuth.getAllUsers();
            const userList = Object.values(users).filter(u => !u.isAI);
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ì•„ì´ë””</th>
                            <th>ê³¨ë“œ</th>
                            <th>ë‚˜ì´</th>
                            <th>ìƒì </th>
                            <th>íŒë§¤ ìƒí’ˆ</th>
                            <th>íŒë§¤ íšŸìˆ˜</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            userList.forEach(user => {
                const shopType = user.shop ? DataManager.getShopType(user.shop.type) : null;
                const salesCount = (user.salesHistory || []).length;
                
                html += `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.gold}G</td>
                        <td>${user.age || '-'}ì„¸</td>
                        <td>${shopType ? shopType.emoji + ' ' + shopType.name : '-'}</td>
                        <td>${(user.products || []).length}ê°œ</td>
                        <td>${salesCount}íšŒ</td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-small" onclick="viewUserDetail('${user.username}')">ìƒì„¸</button>
                            <button class="btn btn-small btn-danger" onclick="deleteUser('${user.username}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            if (userList.length === 0) {
                html = '<p style="text-align:center;padding:40px;color:#999;">ë“±ë¡ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            document.getElementById('usersList').innerHTML = html;
        }

        function viewUserDetail(username) {
            const users = DeviceAuth.getAllUsers();
            const user = users[username];
            
            if (!user) {
                toast('ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const shopType = user.shop ? DataManager.getShopType(user.shop.type) : null;
            const salesHistory = user.salesHistory || [];
            const totalRevenue = salesHistory.reduce((sum, sale) => sum + sale.price, 0);
            
            let html = `
                <div class="modal-title">ğŸ‘¤ ${username} ì •ë³´</div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸ’° ê¸°ë³¸ ì •ë³´</h3>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                        <div>
                            <label>ê³¨ë“œ</label>
                            <input type="number" id="editGold" value="${user.gold}">
                        </div>
                        <div>
                            <label>ë‚˜ì´</label>
                            <input type="number" id="editAge" value="${user.age || 0}">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸª ìƒì  ì •ë³´</h3>
                    <p>${shopType ? shopType.emoji + ' ' + shopType.name : 'ìƒì  ì—†ìŒ'}</p>
                    ${user.shops && user.shops.length > 1 ? `<p style="font-size:13px;color:#666;margin-top:5px;">ì´ ${user.shops.length}ê°œ ìƒì  ìš´ì˜</p>` : ''}
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸ“Š í†µê³„</h3>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                        <div style="text-align:center;background:white;padding:15px;border-radius:8px;">
                            <div style="font-size:24px;font-weight:700;color:#667eea;">${user.stats?.made || 0}</div>
                            <div style="font-size:12px;color:#666;">ì œì‘</div>
                        </div>
                        <div style="text-align:center;background:white;padding:15px;border-radius:8px;">
                            <div style="font-size:24px;font-weight:700;color:#28a745;">${salesHistory.length}</div>
                            <div style="font-size:12px;color:#666;">íŒë§¤</div>
                        </div>
                        <div style="text-align:center;background:white;padding:15px;border-radius:8px;">
                            <div style="font-size:24px;font-weight:700;color:#ffc107;">${totalRevenue.toLocaleString()}</div>
                            <div style="font-size:12px;color:#666;">ìˆ˜ìµ</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸ“¦ ë³´ìœ  ì¬ê³ </h3>
                    ${Object.keys(user.inventory || {}).length > 0 ? 
                        Object.entries(user.inventory).map(([id, count]) => {
                            const ing = DataManager.getIngredient(id);
                            return ing ? `<div>${ing.emoji} ${ing.name}: ${count}ê°œ</div>` : '';
                        }).join('') 
                        : '<p style="color:#999;">ì¬ê³  ì—†ìŒ</p>'
                    }
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸ›’ íŒë§¤ ì¤‘ì¸ ìƒí’ˆ</h3>
                    ${(user.products || []).length > 0 ?
                        user.products.map(p => `<div>${p.emoji} ${p.name} - ${p.price}G</div>`).join('')
                        : '<p style="color:#999;">íŒë§¤ ìƒí’ˆ ì—†ìŒ</p>'
                    }
                </div>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="saveUserEdit('${username}')">ğŸ’¾ ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
        }

        function saveUserEdit(username) {
            const users = DeviceAuth.getAllUsers();
            const user = users[username];
            
            user.gold = parseInt(document.getElementById('editGold').value);
            user.age = parseInt(document.getElementById('editAge').value);
            
            DeviceAuth.saveAllUsers(users);
            closeModal();
            toast('ì €ì¥ ì™„ë£Œ!');
            loadUsers();
        }

        function deleteUser(username) {
            if (!confirm(`ì •ë§ "${username}" ìœ ì €ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const users = DeviceAuth.getAllUsers();
            delete users[username];
            DeviceAuth.saveAllUsers(users);
            
            toast('ì‚­ì œ ì™„ë£Œ');
            loadUsers();
        }

        // ==================== ê²Œì„ ì„¤ì • ====================
        function loadSettings() {
            const settings = GameSettings.get();
            
            const html = `
                <div class="setting-item">
                    <div class="setting-label">ğŸ’° ì´ˆê¸° ê³¨ë“œ</div>
                    <div class="setting-desc">ì‹ ê·œ ìœ ì €ê°€ ì‹œì‘í•  ë•Œ ë°›ëŠ” ê³¨ë“œ</div>
                    <input type="number" id="setting_initialGold" value="${settings.initialGold}" min="0">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸª ì²« ë§¤ì¥ ë¹„ìš©</div>
                    <div class="setting-desc">ì²« ë²ˆì§¸ ë§¤ì¥ì„ ì˜¤í”ˆí•  ë•Œ ë“œëŠ” ê³¨ë“œ</div>
                    <input type="number" id="setting_firstShopCost" value="${settings.firstShopCost}" min="0">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ¬ ì¶”ê°€ ë§¤ì¥ ë¹„ìš©</div>
                    <div class="setting-desc">ë‘ ë²ˆì§¸ ì´í›„ ë§¤ì¥ì„ ì¶”ê°€í•  ë•Œ ë“œëŠ” ê³¨ë“œ</div>
                    <input type="number" id="setting_additionalShopCost" value="${settings.additionalShopCost}" min="0">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">â±ï¸ AI ë°°ê³ í”” ì¦ê°€ ì‹œê°„ (ì´ˆ)</div>
                    <div class="setting-desc">AIì˜ ë°°ê³ í””ì´ ì¦ê°€í•˜ëŠ” ê°„ê²© (ë°€ë¦¬ì´ˆë¥¼ ì´ˆë¡œ í‘œì‹œ)</div>
                    <input type="number" id="setting_aiHungerInterval" value="${settings.aiHungerInterval / 1000}" min="1">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ“ˆ AI ë°°ê³ í”” ì¦ê°€ëŸ‰ (%)</div>
                    <div class="setting-desc">ë§¤ ê°„ê²©ë§ˆë‹¤ ì¦ê°€í•˜ëŠ” ë°°ê³ í”” í¼ì„¼íŠ¸</div>
                    <input type="number" id="setting_aiHungerIncrement" value="${settings.aiHungerIncrement}" min="0.1" step="0.1">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ›’ AI êµ¬ë§¤ ì‹œë„ ê°„ê²© (ì´ˆ)</div>
                    <div class="setting-desc">AIê°€ êµ¬ë§¤ë¥¼ ì‹œë„í•˜ëŠ” ê°„ê²©</div>
                    <input type="number" id="setting_aiPurchaseInterval" value="${settings.aiPurchaseInterval / 1000}" min="1">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ² AI êµ¬ë§¤ í™•ë¥  (%)</div>
                    <div class="setting-desc">AIê°€ êµ¬ë§¤ë¥¼ ì‹œë„í•  ë•Œ ì‹¤ì œë¡œ êµ¬ë§¤í•  í™•ë¥  (0-100)</div>
                    <input type="number" id="setting_aiPurchaseChance" value="${settings.aiPurchaseChance * 100}" min="0" max="100">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ’µ ë ˆì‹œí”¼ ê°€ê²© ë¹„ìœ¨</div>
                    <div class="setting-desc">ì œì‘ë¹„ Ã— Në°° = ì ì • íŒë§¤ê°€</div>
                    <input type="number" id="setting_recipePriceMultiplier" value="${settings.recipePriceMultiplier}" min="1" step="0.5">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸŸ¢ ì‰¬ìš´ ë¬¸ì œ ë³´ìƒ (G)</div>
                    <div class="setting-desc">ì‰¬ìš´ ë¬¸ì œë¥¼ ë§ì·„ì„ ë•Œ ë°›ëŠ” ê³¨ë“œ</div>
                    <input type="number" id="setting_easyQuestionReward" value="${settings.easyQuestionReward}" min="1">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸŸ¡ ì¤‘ê°„ ë¬¸ì œ ë³´ìƒ (G)</div>
                    <div class="setting-desc">ì¤‘ê°„ ë¬¸ì œë¥¼ ë§ì·„ì„ ë•Œ ë°›ëŠ” ê³¨ë“œ</div>
                    <input type="number" id="setting_mediumQuestionReward" value="${settings.mediumQuestionReward}" min="1">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ”´ ì–´ë ¤ìš´ ë¬¸ì œ ë³´ìƒ (G)</div>
                    <div class="setting-desc">ì–´ë ¤ìš´ ë¬¸ì œë¥¼ ë§ì·„ì„ ë•Œ ë°›ëŠ” ê³¨ë“œ</div>
                    <input type="number" id="setting_hardQuestionReward" value="${settings.hardQuestionReward}" min="1">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ğŸ’¬ ìƒí’ˆë‹¹ ìµœëŒ€ ëŒ“ê¸€ ìˆ˜</div>
                    <div class="setting-desc">í•˜ë‚˜ì˜ ìƒí’ˆì— ë‹¬ë¦´ ìˆ˜ ìˆëŠ” ìµœëŒ€ ëŒ“ê¸€ ê°œìˆ˜</div>
                    <input type="number" id="setting_maxCommentsPerProduct" value="${settings.maxCommentsPerProduct}" min="1">
                </div>
            `;
            
            document.getElementById('settingsGrid').innerHTML = html;
        }

        function saveSettings() {
            const settings = {
                initialGold: parseInt(document.getElementById('setting_initialGold').value),
                firstShopCost: parseInt(document.getElementById('setting_firstShopCost').value),
                additionalShopCost: parseInt(document.getElementById('setting_additionalShopCost').value),
                aiHungerInterval: parseInt(document.getElementById('setting_aiHungerInterval').value) * 1000,
                aiHungerIncrement: parseFloat(document.getElementById('setting_aiHungerIncrement').value),
                aiPurchaseInterval: parseInt(document.getElementById('setting_aiPurchaseInterval').value) * 1000,
                aiPurchaseChance: parseFloat(document.getElementById('setting_aiPurchaseChance').value) / 100,
                recipePriceMultiplier: parseFloat(document.getElementById('setting_recipePriceMultiplier').value),
                easyQuestionReward: parseInt(document.getElementById('setting_easyQuestionReward').value),
                mediumQuestionReward: parseInt(document.getElementById('setting_mediumQuestionReward').value),
                hardQuestionReward: parseInt(document.getElementById('setting_hardQuestionReward').value),
                maxCommentsPerProduct: parseInt(document.getElementById('setting_maxCommentsPerProduct').value),
                // BGM
                bgmEnabled: document.getElementById('bgm_enabled').checked,
                bgmSourceType: document.getElementById('bgm_sourceType').value === 'data' ? 'data' : 'url',
                bgmUrl: document.getElementById('bgm_url').value.trim(),
                bgmDataKey: document.getElementById('bgm_dataKey').value.trim(),
                bgmVolume: parseFloat(document.getElementById('bgm_volume').value || '0.35')
            };
            
            GameSettings.save(settings);
            toast('ì„¤ì • ì €ì¥ ì™„ë£Œ!');
        }

        function resetSettings() {
            if (!confirm('ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            GameSettings.resetToDefault();
            loadSettings();
            toast('ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™” ì™„ë£Œ!');
        }

        // ==================== ì‹ë‹¹ ê´€ë¦¬ ====================
        function loadShopTypes() {
            const shopTypes = DataManager.getShopTypes();
            
            let html = '';
            shopTypes.forEach(shop => {
                const recipes = DataManager.getRecipes(shop.id);
                
                html += `
                    <div class="item">
                        <div class="item-header">
                            <div class="item-emoji">${shop.emoji}</div>
                            <div class="item-info">
                                <div class="item-name">${shop.name}</div>
                                <div class="item-desc">ì¶”ê°€ ë¹„ìš©: ${shop.addCost}G | ë ˆì‹œí”¼: ${recipes.length}ê°œ</div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="editShopType('${shop.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-small btn-danger" onclick="deleteShopType('${shop.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('shopTypesList').innerHTML = html || '<p style="text-align:center;padding:40px;color:#999;">ë“±ë¡ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function openAddShopTypeModal() {
            const html = `
                <div class="modal-title">ğŸª ìƒˆ ì‹ë‹¹ ì¶”ê°€</div>
                
                <label>ì‹ë‹¹ ì´ë¦„</label>
                <input type="text" id="shopName" placeholder="ì˜ˆ: íƒ€ì½” ì „ë¬¸ì ">
                
                <label>ì´ëª¨ì§€</label>
                <input type="text" id="shopEmoji" placeholder="ğŸŒ®" maxlength="2">
                
                <label>ì¶”ê°€ ë¹„ìš© (G)</label>
                <input type="number" id="shopCost" value="500" min="0">
                
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <div style="font-size:13px;font-weight:600;margin-bottom:5px;">ë¯¸ë¦¬ë³´ê¸°</div>
                    <div style="font-size:24px;" id="shopPreview">-</div>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="btn" onclick="saveNewShopType()">ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
            
            ['shopName', 'shopEmoji', 'shopCost'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateShopPreview);
            });
        }

        function updateShopPreview() {
            const name = document.getElementById('shopName').value || '-';
            const emoji = document.getElementById('shopEmoji').value || 'ğŸª';
            const cost = document.getElementById('shopCost').value || '0';
            
            document.getElementById('shopPreview').textContent = `${emoji} ${name} (${cost}G)`;
        }

        function saveNewShopType() {
            const name = document.getElementById('shopName').value.trim();
            const emoji = document.getElementById('shopEmoji').value.trim();
            const cost = parseInt(document.getElementById('shopCost').value);
            
            if (!name) {
                toast('ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!emoji) {
                toast('ì´ëª¨ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            DataManager.addShopType({ name, emoji, addCost: cost });
            closeModal();
            toast('ì‹ë‹¹ ì¶”ê°€ ì™„ë£Œ!');
            loadShopTypes();
        }

        function editShopType(id) {
            const shop = DataManager.getShopType(id);
            
            const html = `
                <div class="modal-title">ğŸª ì‹ë‹¹ ìˆ˜ì •</div>
                
                <label>ì‹ë‹¹ ì´ë¦„</label>
                <input type="text" id="editShopName" value="${shop.name}">
                
                <label>ì´ëª¨ì§€</label>
                <input type="text" id="editShopEmoji" value="${shop.emoji}" maxlength="2">
                
                <label>ì¶”ê°€ ë¹„ìš© (G)</label>
                <input type="number" id="editShopCost" value="${shop.addCost}" min="0">
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="updateShopType('${id}')">ğŸ’¾ ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
        }

        function updateShopType(id) {
            const updates = {
                name: document.getElementById('editShopName').value.trim(),
                emoji: document.getElementById('editShopEmoji').value.trim(),
                addCost: parseInt(document.getElementById('editShopCost').value)
            };
            
            DataManager.updateShopType(id, updates);
            closeModal();
            toast('ìˆ˜ì • ì™„ë£Œ!');
            loadShopTypes();
        }

        function deleteShopType(id) {
            const recipes = DataManager.getRecipes(id);
            
            if (recipes.length > 0) {
                if (!confirm(`ì´ ì‹ë‹¹ì˜ ë ˆì‹œí”¼ ${recipes.length}ê°œê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            }
            
            DataManager.deleteShopType(id);
            toast('ì‚­ì œ ì™„ë£Œ');
            loadShopTypes();
            loadRecipes();
        }

        // ==================== ì¬ë£Œ ê´€ë¦¬ ====================
        function loadIngredients() {
            const ingredients = DataManager.getIngredients();
            
            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
            const categories = {
                fruit: { name: 'ğŸ ê³¼ì¼', items: [] },
                dairy: { name: 'ğŸ¥› ìœ ì œí’ˆ', items: [] },
                grain: { name: 'ğŸŒ¾ ê³¡ë¬¼/ë©´/ë¹µ', items: [] },
                sweet: { name: 'ğŸ¬ ë‹¨ë§›/ë””ì €íŠ¸', items: [] },
                protein: { name: 'ğŸ– ë‹¨ë°±ì§ˆ/ê³ ê¸°', items: [] },
                seafood: { name: 'ğŸ¦ í•´ì‚°ë¬¼', items: [] },
                vegetable: { name: 'ğŸ¥¬ ì•¼ì±„', items: [] },
                sauce: { name: 'ğŸ¥« ì†ŒìŠ¤/ì–‘ë…', items: [] },
                other: { name: 'ğŸ“¦ ê¸°íƒ€', items: [] }
            };
            
            ingredients.forEach(ing => {
                const cat = ing.category || 'other';
                if (categories[cat]) {
                    categories[cat].items.push(ing);
                } else {
                    categories.other.items.push(ing);
                }
            });
            
            let html = '';
            Object.values(categories).forEach(cat => {
                if (cat.items.length > 0) {
                    html += `
                        <div class="category-section">
                            <div class="category-title">${cat.name} (${cat.items.length}ê°œ)</div>
                            <div class="grid">
                    `;
                    
                    cat.items.forEach(ing => {
                        html += `
                            <div class="item">
                                <div class="item-header">
                                    <div class="item-emoji">${ing.emoji}</div>
                                    <div class="item-info">
                                        <div class="item-name">${ing.name}</div>
                                        <div class="item-desc">${ing.price}G</div>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-small" onclick="editIngredient('${ing.id}')">ìˆ˜ì •</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteIngredient('${ing.id}')">ì‚­ì œ</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('ingredientsList').innerHTML = html || '<p style="text-align:center;padding:40px;color:#999;">ë“±ë¡ëœ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function openAddIngredientModal() {
            const html = `
                <div class="modal-title">ğŸ§ª ìƒˆ ì¬ë£Œ ì¶”ê°€</div>
                
                <label>ì¬ë£Œ ì´ë¦„</label>
                <input type="text" id="ingName" placeholder="ì˜ˆ: ë§ˆìš”ë„¤ì¦ˆ">
                
                <label>ì´ëª¨ì§€</label>
                <input type="text" id="ingEmoji" placeholder="ğŸ¥«" maxlength="2">
                
                <label>ê°€ê²© (G)</label>
                <input type="number" id="ingPrice" value="3" min="1">
                
                <label>ì¹´í…Œê³ ë¦¬</label>
                <select id="ingCategory">
                    <option value="fruit">ğŸ ê³¼ì¼</option>
                    <option value="dairy">ğŸ¥› ìœ ì œí’ˆ</option>
                    <option value="grain">ğŸŒ¾ ê³¡ë¬¼</option>
                    <option value="sweet">ğŸ¬ ë‹¨ë§›</option>
                    <option value="protein">ğŸ– ë‹¨ë°±ì§ˆ</option>
                    <option value="vegetable">ğŸ¥¬ ì•¼ì±„</option>
                    <option value="sauce">ğŸ¥« ì†ŒìŠ¤</option>
                    <option value="other">ğŸ“¦ ê¸°íƒ€</option>
                </select>
                
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <div style="font-size:13px;font-weight:600;margin-bottom:5px;">ë¯¸ë¦¬ë³´ê¸°</div>
                    <div style="font-size:24px;" id="ingPreview">-</div>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="btn" onclick="saveNewIngredient()">ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
            
            ['ingName', 'ingEmoji', 'ingPrice'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateIngPreview);
            });
        }

        function updateIngPreview() {
            const name = document.getElementById('ingName').value || '-';
            const emoji = document.getElementById('ingEmoji').value || 'ğŸ§ª';
            const price = document.getElementById('ingPrice').value || '0';
            
            document.getElementById('ingPreview').textContent = `${emoji} ${name} - ${price}G`;
        }

        function saveNewIngredient() {
            const name = document.getElementById('ingName').value.trim();
            const emoji = document.getElementById('ingEmoji').value.trim();
            const price = parseInt(document.getElementById('ingPrice').value);
            const category = document.getElementById('ingCategory').value;
            
            if (!name) {
                toast('ì¬ë£Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!emoji) {
                toast('ì´ëª¨ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            DataManager.addIngredient({ name, emoji, price, category });
            closeModal();
            toast('ì¬ë£Œ ì¶”ê°€ ì™„ë£Œ!');
            loadIngredients();
        }

        function editIngredient(id) {
            const ing = DataManager.getIngredient(id);
            
            const html = `
                <div class="modal-title">ğŸ§ª ì¬ë£Œ ìˆ˜ì •</div>
                
                <label>ì¬ë£Œ ì´ë¦„</label>
                <input type="text" id="editIngName" value="${ing.name}">
                
                <label>ì´ëª¨ì§€</label>
                <input type="text" id="editIngEmoji" value="${ing.emoji}" maxlength="2">
                
                <label>ê°€ê²© (G)</label>
                <input type="number" id="editIngPrice" value="${ing.price}" min="1">
                
                <label>ì¹´í…Œê³ ë¦¬</label>
                <select id="editIngCategory">
                    <option value="fruit" ${ing.category==='fruit'?'selected':''}>ğŸ ê³¼ì¼</option>
                    <option value="dairy" ${ing.category==='dairy'?'selected':''}>ğŸ¥› ìœ ì œí’ˆ</option>
                    <option value="grain" ${ing.category==='grain'?'selected':''}>ğŸŒ¾ ê³¡ë¬¼</option>
                    <option value="sweet" ${ing.category==='sweet'?'selected':''}>ğŸ¬ ë‹¨ë§›</option>
                    <option value="protein" ${ing.category==='protein'?'selected':''}>ğŸ– ë‹¨ë°±ì§ˆ</option>
                    <option value="vegetable" ${ing.category==='vegetable'?'selected':''}>ğŸ¥¬ ì•¼ì±„</option>
                    <option value="sauce" ${ing.category==='sauce'?'selected':''}>ğŸ¥« ì†ŒìŠ¤</option>
                    <option value="other" ${ing.category==='other'?'selected':''}>ğŸ“¦ ê¸°íƒ€</option>
                </select>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="updateIngredient('${id}')">ğŸ’¾ ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
        }

        function updateIngredient(id) {
            const updates = {
                name: document.getElementById('editIngName').value.trim(),
                emoji: document.getElementById('editIngEmoji').value.trim(),
                price: parseInt(document.getElementById('editIngPrice').value),
                category: document.getElementById('editIngCategory').value
            };
            
            DataManager.updateIngredient(id, updates);
            closeModal();
            toast('ìˆ˜ì • ì™„ë£Œ!');
            loadIngredients();
        }

        function deleteIngredient(id) {
            const ing = DataManager.getIngredient(id);
            
            // ì´ ì¬ë£Œë¥¼ ì‚¬ìš©í•˜ëŠ” ë ˆì‹œí”¼ í™•ì¸
            const allRecipes = DataManager.getRecipes();
            const usedIn = allRecipes.filter(r => 
                r.ingredients.some(i => i.ingredientId === id)
            );
            
            if (usedIn.length > 0) {
                if (!confirm(`ì´ ì¬ë£Œë¥¼ ì‚¬ìš©í•˜ëŠ” ë ˆì‹œí”¼ ${usedIn.length}ê°œì—ì„œ ì œê±°ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            }
            
            DataManager.deleteIngredient(id);
            toast('ì‚­ì œ ì™„ë£Œ');
            loadIngredients();
            loadRecipes();
        }

        // ==================== ë ˆì‹œí”¼ ê´€ë¦¬ ====================
        function loadRecipes() {
            const shopTypes = DataManager.getShopTypes();
            
            let html = '';
            let totalCount = 0;
            shopTypes.forEach(shop => {
                const recipes = DataManager.getRecipes(shop.id);
                totalCount += recipes.length;
                
                if (recipes.length > 0) {
                    html += `
                        <div class="category-section" style="margin-bottom:15px;">
                            <div class="category-title" style="cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;" 
                                 onclick="toggleRecipeSection('sec_${shop.id}', this)">
                                <span>${shop.emoji} ${shop.name} (${recipes.length}ê°œ)</span>
                                <span class="toggle-arrow" style="font-size:18px;transition:transform 0.2s;">â–¶</span>
                            </div>
                            <div id="sec_${shop.id}" style="display:none;">
                                <div class="grid">
                    `;
                    
                    recipes.forEach(recipe => {
                        const cost = DataManager.calculateRecipeCost(recipe.id);
                        const fairPrice = Math.round(cost * GameSettings.getRecipePriceMultiplier());
                        
                        const ingText = recipe.ingredients.map(ing => {
                            const ingredient = DataManager.getIngredient(ing.ingredientId);
                            return ingredient ? `${ingredient.emoji}Ã—${ing.amount}` : '';
                        }).join(' ');
                        
                        html += `
                            <div class="item">
                                <div class="item-header">
                                    <div class="item-emoji">${recipe.emoji}</div>
                                    <div class="item-info">
                                        <div class="item-name">${recipe.name}</div>
                                        <div class="item-desc">${ingText}</div>
                                        <div class="item-desc">ì œì‘ë¹„: ${cost}G | ì ì •ê°€: ${fairPrice}G</div>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-small" onclick="editRecipe(${recipe.id})">ìˆ˜ì •</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteRecipe(${recipe.id})">ì‚­ì œ</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html = `<p style="margin-bottom:15px;color:#666;">ì´ ${totalCount}ê°œ ë ˆì‹œí”¼ | ì—…ì¢…ì„ í´ë¦­í•˜ë©´ í¼ì³ì§‘ë‹ˆë‹¤</p>` + html;
            
            document.getElementById('recipesList').innerHTML = html || '<p style="text-align:center;padding:40px;color:#999;">ë“±ë¡ëœ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        
        function toggleRecipeSection(id, header) {
            const el = document.getElementById(id);
            const arrow = header.querySelector('.toggle-arrow');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                el.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function openAddRecipeModal() {
            const shopTypes = DataManager.getShopTypes();
            const ingredients = DataManager.getIngredients();
            
            let shopOptions = '';
            shopTypes.forEach(shop => {
                shopOptions += `<option value="${shop.id}">${shop.emoji} ${shop.name}</option>`;
            });
            
            const html = `
                <div class="modal-title">ğŸ“‹ ìƒˆ ë ˆì‹œí”¼ ì¶”ê°€</div>
                
                <label>ë ˆì‹œí”¼ ì´ë¦„</label>
                <input type="text" id="recipeName" placeholder="ì˜ˆ: íƒ€ì½”">
                
                <label>ì´ëª¨ì§€</label>
                <input type="text" id="recipeEmoji" placeholder="ğŸŒ®" maxlength="2">
                
                <label>ì–´ëŠ ì‹ë‹¹ìš©?</label>
                <select id="recipeShopType">
                    ${shopOptions}
                </select>
                
                <label>ì¬ë£Œ ì„ íƒ</label>
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <select id="ingredientSelector" style="margin-bottom:10px;">
                        <option value="">ì¬ë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        ${ingredients.map(ing => 
                            `<option value="${ing.id}">${ing.emoji} ${ing.name} (${ing.price}G)</option>`
                        ).join('')}
                    </select>
                    <button class="btn btn-small btn-success" onclick="addIngredientToRecipe()">+ ì¶”ê°€</button>
                    
                    <div id="selectedIngredients" style="margin-top:15px;"></div>
                </div>
                
                <div style="background:#e9ecef;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <div style="font-size:13px;font-weight:600;margin-bottom:10px;">ğŸ’° ìë™ ê³„ì‚°</div>
                    <div id="costCalculation">ì¬ë£Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”</div>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="btn" onclick="saveNewRecipe()">ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
            window.selectedRecipeIngredients = [];
        }

        function addIngredientToRecipe() {
            const selector = document.getElementById('ingredientSelector');
            const ingId = selector.value;
            
            if (!ingId) {
                toast('ì¬ë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            const ingredient = DataManager.getIngredient(ingId);
            
            // ì´ë¯¸ ì¶”ê°€ëœ ì¬ë£Œì¸ì§€ í™•ì¸
            if (window.selectedRecipeIngredients.find(i => i.ingredientId === ingId)) {
                toast('ì´ë¯¸ ì¶”ê°€ëœ ì¬ë£Œì…ë‹ˆë‹¤');
                return;
            }
            
            window.selectedRecipeIngredients.push({
                ingredientId: ingId,
                amount: 1
            });
            
            renderSelectedIngredients();
            updateRecipeCostCalculation();
        }

        function renderSelectedIngredients() {
            const container = document.getElementById('selectedIngredients');
            
            if (window.selectedRecipeIngredients.length === 0) {
                container.innerHTML = '<p style="color:#999;font-size:13px;">ì„ íƒëœ ì¬ë£Œ ì—†ìŒ</p>';
                return;
            }
            
            let html = '';
            window.selectedRecipeIngredients.forEach((item, idx) => {
                const ing = DataManager.getIngredient(item.ingredientId);
                if (ing) {
                    html += `
                        <div style="display:flex;align-items:center;gap:10px;background:white;padding:10px;border-radius:8px;margin-bottom:8px;">
                            <div style="font-size:24px;">${ing.emoji}</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;">${ing.name}</div>
                                <div style="font-size:12px;color:#666;">${ing.price}G</div>
                            </div>
                            <input type="number" value="${item.amount}" min="1" 
                                   style="width:60px;padding:5px;margin:0;" 
                                   onchange="updateIngredientAmount(${idx}, this.value)">
                            <button class="btn btn-small btn-danger" onclick="removeIngredientFromRecipe(${idx})">X</button>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function updateIngredientAmount(idx, amount) {
            window.selectedRecipeIngredients[idx].amount = parseInt(amount) || 1;
            updateRecipeCostCalculation();
        }

        function removeIngredientFromRecipe(idx) {
            window.selectedRecipeIngredients.splice(idx, 1);
            renderSelectedIngredients();
            updateRecipeCostCalculation();
        }

        function updateRecipeCostCalculation() {
            let totalCost = 0;
            let html = '<div style="font-size:12px;">';
            
            window.selectedRecipeIngredients.forEach(item => {
                const ing = DataManager.getIngredient(item.ingredientId);
                if (ing) {
                    const cost = ing.price * item.amount;
                    totalCost += cost;
                    html += `<div>${ing.emoji} ${ing.name}: ${ing.price}G Ã— ${item.amount} = ${cost}G</div>`;
                }
            });
            
            const multiplier = GameSettings.getRecipePriceMultiplier();
            const fairPrice = totalCost * multiplier;
            
            html += `<div style="border-top:1px solid #ddd;margin-top:8px;padding-top:8px;">`;
            html += `<div style="font-weight:600;">í•©ê³„: ${totalCost}G</div>`;
            html += `<div style="font-weight:600;color:#667eea;">ì ì •ê°€: ${totalCost}G Ã— ${multiplier}ë°° = ${fairPrice}G</div>`;
            html += `</div></div>`;
            
            document.getElementById('costCalculation').innerHTML = html;
        }

        function saveNewRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const emoji = document.getElementById('recipeEmoji').value.trim();
            const shopType = document.getElementById('recipeShopType').value;
            
            if (!name) {
                toast('ë ˆì‹œí”¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!emoji) {
                toast('ì´ëª¨ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (window.selectedRecipeIngredients.length === 0) {
                toast('ì¬ë£Œë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•˜ì„¸ìš”');
                return;
            }
            
            DataManager.addRecipe({
                name,
                emoji,
                shopType,
                ingredients: window.selectedRecipeIngredients
            });
            
            closeModal();
            toast('ë ˆì‹œí”¼ ì¶”ê°€ ì™„ë£Œ!');
            loadRecipes();
        }

        function editRecipe(id) {
            // ê°„ë‹¨í•œ ìˆ˜ì • ê¸°ëŠ¥ (ì´ë¦„/ì´ëª¨ì§€ë§Œ)
            const recipe = DataManager.getRecipe(id);
            
            const html = `
                <div class="modal-title">ğŸ“‹ ë ˆì‹œí”¼ ìˆ˜ì •</div>
                <p style="font-size:13px;color:#666;margin-bottom:15px;">í˜„ì¬ëŠ” ì´ë¦„ê³¼ ì´ëª¨ì§€ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                
                <label>ë ˆì‹œí”¼ ì´ë¦„</label>
                <input type="text" id="editRecipeName" value="${recipe.name}">
                
                <label>ì´ëª¨ì§€</label>
                <input type="text" id="editRecipeEmoji" value="${recipe.emoji}" maxlength="2">
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="updateRecipe(${id})">ğŸ’¾ ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
        }

        function updateRecipe(id) {
            const updates = {
                name: document.getElementById('editRecipeName').value.trim(),
                emoji: document.getElementById('editRecipeEmoji').value.trim()
            };
            
            DataManager.updateRecipe(id, updates);
            closeModal();
            toast('ìˆ˜ì • ì™„ë£Œ!');
            loadRecipes();
        }

        function deleteRecipe(id) {
            if (!confirm('ì •ë§ ì´ ë ˆì‹œí”¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            DataManager.deleteRecipe(id);
            toast('ì‚­ì œ ì™„ë£Œ');
            loadRecipes();
        }

        // ==================== ë¬¸ì œ ê´€ë¦¬ ====================
        function loadQuestions() {
            const questions = DataManager.getQuestions();
            
            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
            const categories = {};
            questions.forEach(q => {
                const cat = q.category || 'general';
                if (!categories[cat]) {
                    categories[cat] = [];
                }
                categories[cat].push(q);
            });
            
            let html = '';
            Object.entries(categories).forEach(([catName, items]) => {
                const catLabels = {
                    math: 'ğŸ”¢ ìˆ˜í•™',
                    science: 'ğŸ”¬ ê³¼í•™',
                    general: 'ğŸ“š ìƒì‹'
                };
                
                html += `
                    <div class="category-section">
                        <div class="category-title">${catLabels[catName] || catName} (${items.length}ê°œ)</div>
                        <div class="grid">
                `;
                
                items.forEach(q => {
                    const diffColors = {
                        easy: '#28a745',
                        medium: '#ffc107',
                        hard: '#dc3545'
                    };
                    
                    html += `
                        <div class="item">
                            <div style="margin-bottom:10px;">
                                <div style="font-weight:600;margin-bottom:5px;">Q: ${q.question}</div>
                                <div style="font-size:13px;color:#666;margin-bottom:5px;">
                                    ${q.options.map((opt, idx) => 
                                        `<div>${idx === q.correctIndex ? 'âœ“' : ''} ${idx+1}. ${opt}</div>`
                                    ).join('')}
                                </div>
                                <div style="font-size:12px;margin-top:8px;">
                                    <span style="color:${diffColors[q.difficulty] || '#666'};">
                                        ë‚œì´ë„: ${q.difficulty || 'easy'}
                                    </span>
                                    <span style="margin-left:10px;color:#667eea;">ë³´ìƒ: ${q.reward || 10}G</span>
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-small" onclick="editQuestion(${q.id})">ìˆ˜ì •</button>
                                <button class="btn btn-small btn-danger" onclick="deleteQuestion(${q.id})">ì‚­ì œ</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('questionsList').innerHTML = html || '<p style="text-align:center;padding:40px;color:#999;">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function openAddQuestionModal() {
            const html = `
                <div class="modal-title">ğŸ’° ìƒˆ ë¬¸ì œ ì¶”ê°€</div>
                
                <label>ë¬¸ì œ</label>
                <input type="text" id="questionText" placeholder="ì˜ˆ: 2 + 2 = ?">
                
                <label>ì„ íƒì§€ 1 (ì •ë‹µ)</label>
                <input type="text" id="option0" placeholder="4">
                
                <label>ì„ íƒì§€ 2</label>
                <input type="text" id="option1" placeholder="3">
                
                <label>ì„ íƒì§€ 3</label>
                <input type="text" id="option2" placeholder="5">
                
                <label>ì„ íƒì§€ 4</label>
                <input type="text" id="option3" placeholder="6">
                
                <label>ì¹´í…Œê³ ë¦¬</label>
                <select id="questionCategory">
                    <option value="math">ğŸ”¢ ìˆ˜í•™</option>
                    <option value="science">ğŸ”¬ ê³¼í•™</option>
                    <option value="general">ğŸ“š ìƒì‹</option>
                </select>
                
                <label>ë‚œì´ë„</label>
                <select id="questionDifficulty">
                    <option value="easy">ì‰¬ì›€</option>
                    <option value="medium">ì¤‘ê°„</option>
                    <option value="hard">ì–´ë ¤ì›€</option>
                </select>
                
                <label>ë³´ìƒ (G)</label>
                <input type="number" id="questionReward" value="10" min="1">
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="saveNewQuestion()">ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
        }

        function saveNewQuestion() {
            const question = document.getElementById('questionText').value.trim();
            const options = [
                document.getElementById('option0').value.trim(),
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim()
            ];
            
            if (!question) {
                toast('ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (options.some(opt => !opt)) {
                toast('ëª¨ë“  ì„ íƒì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            DataManager.addQuestion({
                question,
                options,
                correctIndex: 0, // ì²« ë²ˆì§¸ê°€ í•­ìƒ ì •ë‹µ
                category: document.getElementById('questionCategory').value,
                difficulty: document.getElementById('questionDifficulty').value,
                reward: parseInt(document.getElementById('questionReward').value)
            });
            
            closeModal();
            toast('ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ!');
            loadQuestions();
        }

        function editQuestion(id) {
            const q = DataManager.getQuestion(id);
            
            const html = `
                <div class="modal-title">ğŸ’° ë¬¸ì œ ìˆ˜ì •</div>
                
                <label>ë¬¸ì œ</label>
                <input type="text" id="editQuestionText" value="${q.question}">
                
                <label>ì„ íƒì§€ 1 (ì •ë‹µ)</label>
                <input type="text" id="editOption0" value="${q.options[0]}">
                
                <label>ì„ íƒì§€ 2</label>
                <input type="text" id="editOption1" value="${q.options[1]}">
                
                <label>ì„ íƒì§€ 3</label>
                <input type="text" id="editOption2" value="${q.options[2]}">
                
                <label>ì„ íƒì§€ 4</label>
                <input type="text" id="editOption3" value="${q.options[3]}">
                
                <label>ë‚œì´ë„</label>
                <select id="editQuestionDifficulty">
                    <option value="easy" ${q.difficulty==='easy'?'selected':''}>ì‰¬ì›€</option>
                    <option value="medium" ${q.difficulty==='medium'?'selected':''}>ì¤‘ê°„</option>
                    <option value="hard" ${q.difficulty==='hard'?'selected':''}>ì–´ë ¤ì›€</option>
                </select>
                
                <label>ë³´ìƒ (G)</label>
                <input type="number" id="editQuestionReward" value="${q.reward || 10}" min="1">
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="updateQuestion(${id})">ğŸ’¾ ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
        }

        function updateQuestion(id) {
            const updates = {
                question: document.getElementById('editQuestionText').value.trim(),
                options: [
                    document.getElementById('editOption0').value.trim(),
                    document.getElementById('editOption1').value.trim(),
                    document.getElementById('editOption2').value.trim(),
                    document.getElementById('editOption3').value.trim()
                ],
                difficulty: document.getElementById('editQuestionDifficulty').value,
                reward: parseInt(document.getElementById('editQuestionReward').value)
            };
            
            DataManager.updateQuestion(id, updates);
            closeModal();
            toast('ìˆ˜ì • ì™„ë£Œ!');
            loadQuestions();
        }

        function deleteQuestion(id) {
            if (!confirm('ì •ë§ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            DataManager.deleteQuestion(id);
            toast('ì‚­ì œ ì™„ë£Œ');
            loadQuestions();
        }

        // ==================== íŒŒì¼ ì—…ë¡œë“œ ====================
        function openUploadModal(type) {
            currentUploadType = type;
            
            const typeLabels = {
                shops: 'ğŸª ì‹ë‹¹',
                ingredients: 'ğŸ§ª ì¬ë£Œ',
                recipes: 'ğŸ“‹ ë ˆì‹œí”¼',
                questions: 'ğŸ’° ë¬¸ì œ'
            };
            
            const html = `
                <div class="modal-title">${typeLabels[type]} íŒŒì¼ ì—…ë¡œë“œ</div>
                
                <label class="upload-area" for="fileInput">
                                <div class="upload-icon">ğŸ“</div>
                    <div style="font-size:16px;font-weight:600;margin-bottom:5px;">íŒŒì¼ ì„ íƒ</div>
                    <div style="font-size:13px;color:#666;">JSON íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                
        </label>
        <input type="file" id="fileInput" accept=".json" style="display:none;">
                
                <div style="margin-top:20px;">
                    <label>ë˜ëŠ” JSON í…ìŠ¤íŠ¸ ì§ì ‘ ë¶™ì—¬ë„£ê¸°</label>
                    <textarea id="jsonText" placeholder='{"${type}": [...]}'  style="min-height:150px;font-family:monospace;"></textarea>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn" onclick="uploadFromText()">ğŸ“ í…ìŠ¤íŠ¸ë¡œ ì—…ë¡œë“œ</button>
                    <button class="btn btn-secondary" onclick="downloadSample('${type}')">ğŸ“¥ ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            `;
            
            showModal(html);
            
            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    importData(data);
                } catch (error) {
                    toast('ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function uploadFromText() {
            const text = document.getElementById('jsonText').value.trim();
            
            if (!text) {
                toast('JSON í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            try {
                const data = JSON.parse(text);
                importData(data);
            } catch (error) {
                toast('ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤: ' + error.message);
            }
        }

        function importData(data) {
            let count = 0;
            
            // ì‹ë‹¹
            if (data.shopTypes) {
                data.shopTypes.forEach(shop => {
                    DataManager.addShopType(shop);
                    count++;
                });
                loadShopTypes();
            }
            
            // ì¬ë£Œ
            if (data.ingredients) {
                data.ingredients.forEach(ing => {
                    DataManager.addIngredient(ing);
                    count++;
                });
                loadIngredients();
            }
            
            // ë ˆì‹œí”¼
            if (data.recipes) {
                data.recipes.forEach(recipe => {
                    DataManager.addRecipe(recipe);
                    count++;
                });
                loadRecipes();
            }
            
            // ë¬¸ì œ
            if (data.questions) {
                data.questions.forEach(q => {
                    DataManager.addQuestion(q);
                    count++;
                });
                loadQuestions();
            }
            
            closeModal();
            toast(`ì´ ${count}ê°œ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        function downloadSample(type) {
            let data = {};
            let filename = '';
            
            if (type === 'ingredients') {
                data = {
                    ingredients: [
                        {name: "ë”¸ê¸°", emoji: "ğŸ“", price: 3, category: "fruit"},
                        {name: "ìƒí¬ë¦¼", emoji: "ğŸ¥›", price: 5, category: "dairy"}
                    ]
                };
                filename = 'ingredients-sample.json';
            } else if (type === 'shops') {
                data = {
                    shopTypes: [
                        {name: "íƒ€ì½” ì „ë¬¸ì ", emoji: "ğŸŒ®", addCost: 500}
                    ]
                };
                filename = 'shops-sample.json';
            } else if (type === 'recipes') {
                data = {
                    recipes: [
                        {
                            name: "íƒ€ì½”",
                            emoji: "ğŸŒ®",
                            shopType: "taco",
                            ingredients: [
                                {ingredientId: "lettuce", amount: 1}
                            ]
                        }
                    ]
                };
                filename = 'recipes-sample.json';
            } else if (type === 'questions') {
                data = {
                    questions: [
                        {
                            question: "2 + 2 = ?",
                            options: ["4", "3", "5", "6"],
                            correctIndex: 0,
                            difficulty: "easy",
                            category: "math",
                            reward: 10
                        }
                    ]
                };
                filename = 'questions-sample.json';
            }
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            toast('ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
        }

        console.log('âœ… ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ!');
    </script>

    <script>
        function _adminGetSavedUntil() {
            try { return parseInt(sessionStorage.getItem('admin_authed_until') || '0', 10); } catch(e) { return 0; }
        }
        function _adminSetSavedUntil(ts) {
            try { sessionStorage.setItem('admin_authed_until', String(ts)); } catch(e) {}
        }
        function lockAdminIfNeeded() {
            const now = Date.now();
            const until = _adminGetSavedUntil();
            const lock = document.getElementById('adminLock');
            if (!lock) return;
            // 8ì‹œê°„ ì„¸ì…˜
            if (!until || until < now) {
                lock.style.display = 'flex';
                setTimeout(() => {
                    const input = document.getElementById('adminPasswordInput');
                    if (input) input.focus();
                }, 50);
            }
        }
        function unlockAdmin() {
            const input = document.getElementById('adminPasswordInput');
            const pw = (input && input.value) ? input.value : '';
            const expected = (typeof GameSettings !== 'undefined' && GameSettings.getAdminPassword)
                ? String(GameSettings.getAdminPassword())
                : '1234';
            const ok = pw && pw === expected;
            const err = document.getElementById('adminLockError');
            if (!ok) {
                if (err) err.style.display = 'block';
                return;
            }
            if (err) err.style.display = 'none';
            _adminSetSavedUntil(Date.now() + 8 * 60 * 60 * 1000);
            const lock = document.getElementById('adminLock');
            if (lock) lock.style.display = 'none';
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('adminLock')?.style.display === 'flex') {
                unlockAdmin();
            }
        });
        window.addEventListener('load', lockAdminIfNeeded);
    
        // ==================== BGM ëª¨ë“ˆ (ê´€ë¦¬ì) ====================
        function _bgmLibKey() { return 'BGM_LIBRARY_V1'; }

        function _loadBgmLibrary() {
            try { return JSON.parse(localStorage.getItem(_bgmLibKey()) || '[]'); } catch(e) { return []; }
        }
        function _saveBgmLibrary(list) {
            localStorage.setItem(_bgmLibKey(), JSON.stringify(list || []));
        }

        function renderBgmModule() {
            const s = GameSettings.get();
            // ê¸°ë³¸ê°’ ë°˜ì˜
            document.getElementById('bgm_enabled').checked = (s.bgmEnabled !== false);
            document.getElementById('bgm_sourceType').value = (s.bgmSourceType === 'data') ? 'data' : 'url';
            document.getElementById('bgm_url').value = s.bgmUrl || '';
            document.getElementById('bgm_dataKey').value = s.bgmDataKey || '';
            document.getElementById('bgm_volume').value = (typeof s.bgmVolume === 'number') ? s.bgmVolume : 0.35;

            const lib = _loadBgmLibrary();
            const curType = document.getElementById('bgm_sourceType').value;
            const curKey = document.getElementById('bgm_dataKey').value;
            const curUrl = (document.getElementById('bgm_url').value || '').trim();

            const wrap = document.getElementById('bgm_library');

            if (!lib.length) {
                wrap.innerHTML = '<div style="font-size:13px;color:#777;">ì¶”ê°€ëœ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤. (URL ì¶”ê°€ ë˜ëŠ” íŒŒì¼ ì¶”ê°€)</div>';
                return;
            }

            // ìµœì‹ ìˆœ
            const sorted = [...lib].sort((a,b)=>(b.addedAt||0)-(a.addedAt||0));

            wrap.innerHTML = sorted.map(item => {
                const type = item.type || 'data'; // data/url
                const isActive =
                    (type === 'data' && curType === 'data' && item.key && item.key === curKey) ||
                    (type === 'url'  && curType === 'url'  && item.url && item.url === curUrl);

                const active = isActive ? 'border:2px solid #667eea;' : 'border:1px solid #e5e7eb;';
                const title = (type === 'url')
                    ? (item.name || (item.url ? item.url.split('/').pop() : 'URL BGM'))
                    : (item.name || 'ì˜¤ë””ì˜¤ íŒŒì¼');

                const meta = (type === 'url')
                    ? `<div style="font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.url || ''}</div>`
                    : `<div style="font-size:12px;color:#666;">${new Date(item.addedAt).toLocaleString()}</div>`;

                const btns = (type === 'url')
                    ? `<button class="btn btn-secondary" onclick="bgmUseUrl('${item.key}')">ì‚¬ìš©</button>
                       <button class="btn btn-danger" onclick="bgmDeleteUrl('${item.key}')">ì‚­ì œ</button>`
                    : `<button class="btn btn-secondary" onclick="bgmUseFile('${item.key}')">ì‚¬ìš©</button>
                       <button class="btn btn-danger" onclick="bgmDeleteFile('${item.key}')">ì‚­ì œ</button>`;

                const badge = (type === 'url')
                    ? `<span style="font-size:11px;font-weight:800;color:#4f46e5;background:#eef2ff;padding:4px 8px;border-radius:999px;">URL</span>`
                    : `<span style="font-size:11px;font-weight:800;color:#0f766e;background:#ecfeff;padding:4px 8px;border-radius:999px;">íŒŒì¼</span>`;

                return `
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:14px;${active}">
                        <div style="min-width:0;flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;min-width:0;">
                                ${badge}
                                <div style="font-weight:800;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${title}</div>
                            </div>
                            ${meta}
                            ${type === 'url' ? `<div style="font-size:12px;color:#666;">${new Date(item.addedAt).toLocaleString()}</div>` : ``}
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                            ${btns}
                        </div>
                    </div>
                `;
            }).join('');
        }

            wrap.innerHTML = lib.map(item => {
                const active = (item.key === curKey) ? 'border:2px solid #667eea;' : 'border:1px solid #e5e7eb;';
                return `
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:14px;${active}">
                        <div style="min-width:0;">
                            <div style="font-weight:800;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.name}</div>
                            <div style="font-size:12px;color:#666;">${new Date(item.addedAt).toLocaleString()}</div>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                            <button class="btn btn-secondary" onclick="bgmUseFile('${item.key}')">ì‚¬ìš©</button>
                            <button class="btn btn-danger" onclick="bgmDeleteFile('${item.key}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        
        function bgmAddUrl() {
            const url = (document.getElementById('bgm_url').value || '').trim();
            if (!url) { alert('ì¶”ê°€í•  BGM URLì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

            // ê°„ë‹¨ ê²€ì¦: mp3/wav/ogg ë“± (í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ ì‹¤ìˆ˜ ë°©ì§€)
            const lower = url.toLowerCase();
            const ok = (lower.includes('.mp3') || lower.includes('.wav') || lower.includes('.ogg') || lower.startsWith('data:audio'));
            if (!ok) {
                if (!confirm('ì´ URLì€ mp3/wav/ogg í™•ì¥ìê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì¶”ê°€í• ê¹Œìš”?')) return;
            }

            const raw = 'URL|' + url;
            let hash = 0;
            for (let i = 0; i < raw.length; i++) { hash = ((hash<<5)-hash) + raw.charCodeAt(i); hash |= 0; }
            const key = 'BGM_URL_' + Math.abs(hash);

            const lib = _loadBgmLibrary();
            const exists = lib.find(x => x.key === key);
            if (!exists) {
                const name = url.split('/').pop() || 'BGM URL';
                lib.unshift({ type: 'url', key, name, url, addedAt: Date.now() });
                _saveBgmLibrary(lib);
            }

            // í˜„ì¬ ì„ íƒìœ¼ë¡œ ì§€ì •
            document.getElementById('bgm_sourceType').value = 'url';
            document.getElementById('bgm_dataKey').value = '';
            document.getElementById('bgm_url').value = url;

            alert('ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”.');
            renderBgmModule();
        }

        function bgmUseUrl(key) {
            const lib = _loadBgmLibrary();
            const item = lib.find(x => x.key === key);
            if (!item || !item.url) return;
            document.getElementById('bgm_sourceType').value = 'url';
            document.getElementById('bgm_dataKey').value = '';
            document.getElementById('bgm_url').value = item.url;
            renderBgmModule();
        }

        function bgmDeleteUrl(key) {
            if (!confirm('ì´ URLì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) return;
            const lib = _loadBgmLibrary().filter(x => x.key !== key);
            _saveBgmLibrary(lib);
            renderBgmModule();
        }

function bgmAddFile() {
            const input = document.getElementById('bgm_file');
            const file = input.files && input.files[0];
            if (!file) { alert('ì¶”ê°€í•  ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

            const reader = new FileReader();
            reader.onload = function() {
                const dataUrl = String(reader.result || '');
                if (!dataUrl.startsWith('data:audio')) {
                    alert('ì˜¤ë””ì˜¤ íŒŒì¼ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.');
                    return;
                }

                // ì €ì¥ í‚¤ ìƒì„± (íŒŒì¼ëª…+ê¸¸ì´ ê¸°ì¤€)
                const raw = file.name + '|' + file.size + '|' + dataUrl.length;
                let hash = 0;
                for (let i = 0; i < raw.length; i++) { hash = ((hash<<5)-hash) + raw.charCodeAt(i); hash |= 0; }
                const key = 'BGM_FILE_' + Math.abs(hash);

                try {
                    localStorage.setItem(key, dataUrl);
                } catch(e) {
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ë„ˆë¬´ í¬ë©´ localStorageì— ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. (ì§§ì€/ì‘ì€ íŒŒì¼ë¡œ ì‹œë„í•˜ê±°ë‚˜ URL ë°©ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”)');
                    return;
                }

                const lib = _loadBgmLibrary();
                const exists = lib.find(x => x.key === key);
                if (!exists) {
                    lib.unshift({ type: 'data', key, name: file.name, addedAt: Date.now() });
                    _saveBgmLibrary(lib);
                }

                // í˜„ì¬ ì„ íƒìœ¼ë¡œ ì§€ì •
                document.getElementById('bgm_sourceType').value = 'data';
                document.getElementById('bgm_dataKey').value = key;
                document.getElementById('bgm_url').value = '';

                alert('ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”.');
                renderBgmModule();
            };
            reader.readAsDataURL(file);
        }

        function bgmUseFile(key) {
            document.getElementById('bgm_sourceType').value = 'data';
            document.getElementById('bgm_dataKey').value = key;
            document.getElementById('bgm_url').value = '';
            renderBgmModule();
        }

        function bgmDeleteFile(key) {
            if (!confirm('ì´ íŒŒì¼ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) return;
            const lib = _loadBgmLibrary().filter(x => x.key !== key);
            _saveBgmLibrary(lib);
            try { localStorage.removeItem(key); } catch(e) {}
            if (document.getElementById('bgm_dataKey').value === key) {
                document.getElementById('bgm_dataKey').value = '';
            }
            renderBgmModule();
        }

        function bgmPreview() {
            const player = document.getElementById('bgm_preview_player');
            const type = document.getElementById('bgm_sourceType').value;
            const vol = parseFloat(document.getElementById('bgm_volume').value || '0.35');
            let src = '';
            if (type === 'data') {
                const key = document.getElementById('bgm_dataKey').value;
                src = key ? (localStorage.getItem(key) || '') : '';
            } else {
                src = document.getElementById('bgm_url').value.trim();
            }
            if (!src) { alert('ë¯¸ë¦¬ë“£ê¸° í•  ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. URLì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

            player.style.display = 'block';
            player.src = src;
            player.volume = isFinite(vol) ? Math.max(0, Math.min(1, vol)) : 0.35;
            player.play().catch(()=>{});
        }

        function bgmStopPreview() {
            const player = document.getElementById('bgm_preview_player');
            player.pause();
        }

</script>
</body>
</html>
